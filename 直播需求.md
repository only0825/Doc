gray817gz@gmail.com 1Q2w3e4r@

github: gray817gz@gmail.com 1Q2w3e4r@33

AppleID: gray817gz@gmail.com GxpT6tZnCgEjPP9



公司邮箱  账号: TL007788 密码: 1Q2w3e4r@

**白马开户信息**

| 部门 | 公司英文名 | 手机号码    | 白马会户名 | 国籍     | 月日年    |
| ---- | ---------- | ----------- | ---------- | -------- | --------- |
| GZ1  | Gray       | 09266777773 | baray      | 马来西亚 | 6/21/1992 |



## 20220902

准备做

\1. 聊天室 删除单条消息

\2. 弹幕实现

\5. 赛事推荐 拿的时间也  优先级：有无主播、 开播时间

\6. 机器人 进聊天室 （为了炒直播间）



敏感字未屏蔽 （感觉可以用es做，但暂时不做）



完成：

##### 这里是1级联赛

![image-20220902141440343](/Users/wh37/Library/Application Support/typora-user-images/image-20220902141440343.png)

##### 联赛查询结果改为1、2级（之前为1级）

![image-20220902132614548](/Users/wh37/Library/Application Support/typora-user-images/image-20220902132614548.png)

##### 全部直播和热门直播 看看排序是按什么的

热门直播和全部直播调用的一个接偶/api/live/hotRoom

排序规则：sort从大到小、热度从大到小

sort的优先级高于热度

查询条件：当后台直播管理的推荐开启时 





##### 赛程和未来赛程接口调整 

这两个接口一样 

/api/scheduleMatch/lists

/api/scheduleMatch/matchLists



##### 赛程接口查询时间区间：改为早上的08:00:00点到第二日早上的07:59:59



## 20220903



#### TODO

\1. 聊天室 删除单条消息

\2. 弹幕实现

\5. 赛事推荐 拿的时间也  优先级：有无主播、 开播时间

\6. 机器人 进聊天室 （为了炒直播间）



敏感字未屏蔽 （感觉可以用es做，但暂时不做）





#### 完成

Bug修复：

\1. 预约赛事后取消预约 再次预约该比赛 但名称不会改变的问题

\2. 重新预约相同赛事update_time没有更新问题

\3. 开始预约的直播后显示数据不对，原因：字段和表不符合



直播时长问题：

![image-20220903204350383](/Users/wh37/Library/Application Support/typora-user-images/image-20220903204350383.png)





## 20220905

#### TODO

\1. 聊天室 删除单条消息

\2. 弹幕实现



\6. 机器人 进聊天室 （为了炒直播间）



敏感字未屏蔽 （感觉可以用es做，但暂时不做）



1. 设计篮球联赛赛程表
   * 参考足球赛程表
   * 从飞鲸篮球API的3.赛程赛果 接口拿字段
2. 设计篮球联赛表
   * 看看能不能和足球联赛表兼容，不能就重新设计一个
   * 飞鲸 9.联赛/杯赛资料 这个接口
3. 球队表
   * 飞鲸 12.球队资料

![image-20220905212715621](/Users/wh37/Library/Application Support/typora-user-images/image-20220905212715621.png)

完成

* 赛事推荐 拿的时间也  优先级：有无主播、 开播时间

* **赛事现在是展示8-8时  改回原来的逻辑 展示当天00:00 - 23:59**



根据第三方API 设计篮球联赛赛程表

https://www.feijing88.com/doc?id=37-451&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbiI6ImVlYzkyTGdsbG1tc3lCUFVZR29WbDFtNVRHSXpvb29YTWpPQ3k1bUhQTW91REhEWE53QXM4Qm13WUNzSC9Wd0ciLCJpYXQiOjE2NjE2Nzc2MDZ9.qHaaLJe_YherF-8PW0dGfq-RQ6R4JsOnIdWsUov65Uc





## 20220906

#### TODO

聊天室 删除单条消息

弹幕实现

机器人 进聊天室 （为了炒直播间）

敏感字未屏蔽 （感觉可以用es做，但暂时不做）



完成：

1. **设计篮球联赛赛程表**
   * 参考足球赛程表
   * 从飞鲸篮球API的3.赛程赛果 接口拿字段
2. **设计篮球联赛表**
   * 看看能不能和足球联赛表兼容，不能就重新设计一个
   * 飞鲸 9.联赛/杯赛资料 这个接口
3. **篮球球队表**
   * 飞鲸 12.球队资料

## 20220907

#### TODO

* 文字直播接口

  * http://api.wuhaicj.com/apidoc/#/api?key=api_POST_/api/scheduleMatch/lineup&appKey=api

  * 参考出场阵容接口写一个文字直播接口
  * 接口拼接格式：football/textLive.aspx?language=cn&matchId=2277843

## 20220909

https://www.wutiyu.com/。爬取最新文章的内容

使用 go-query 完成





## 20220910

* /api/scheduleMatch/lineup  出场阵容接口 调整	

* 增加数据：**进球数，助攻数，红牌，黄牌，上场时间和球员头像**
* **进球数**，**助攻数，红牌，黄牌，上场时间**这几个可以从飞鲸 `11.某场比赛`的球员详细技术统计这个接口拿到
* 然后**球员头像**可以从飞鲸这个接口`20.球员资料` 拿到



爬资讯程序有几个问题

* 如果只放测试环境，不放正式环境

  * 图片怎么同步到正式环境，传到图片服务器？或直接用测试地址访问图片？
  * 资讯数据是否需要每日更新，如需要每天都要将数据导入到正式环境的表。

  

## 20220912

### OBS串流秘钥有空格

直播管理：OBS串流秘钥：dhmveB 2000091?txSecret=131c7ee6ee212fae3a01289271a9d256&txTime=632019C1

`$streamName = $this->randomKeys(6) . trim($room_id) = "dhmveB 2000091"`

排查应该是$room_id有空格，用trim去除空格ss



### 出场阵容接口调整

新增两个返回字段， 主队名称 和 客队名称 ，与homeCoachCn同级



### 聊天室断开连接时 删除游客redis数据 Gray817 Yesterday 19:32







## 20220914

需要出三个接口：

1、 获取是否开启审核模式的接口

2、 获取资讯列表接口,支持分页，返回字段包括：资讯id、标题、一张图片地址（没有可以不返回，多张取第一张）

3、 根据id获取资讯详情接口，返回字段包括：资讯id、文章标题、文章内容、图片路径、作者、文章日期

审核模式的话，返回两个字段 ，iOS 和 安卓 各用一个。数字类型， 0 关闭，1开启



4、后台可能还需要一个设置审核模式的接口



## 20220916

完成：资讯列表接口





## 20220919



```
1、 api/scheduleMatch/preList 接口
    需要新增用户是否关注该主播字段返回，未登录默认返回未关注
    scheduled_anchor 返回的是null
    待确认： 是否只有直播中的主播才返回 room_id
2、 api/scheduleMatch/lists 赛程接口
    leagueId 需要支持传多个id查询
```

### 完成：

#### 主播预约赛程接口 /api/scheduleMatch/preList

新增字段

1. 新增用户是否关注该主播字段返回
2. 主播是否在直播 

#### 赛程接口 的参数leagueId 需要支持传多个id查询

api/scheduleMatch/lists 





## 20220921





## TODO

优化表：

1. **设计篮球联赛赛程表**
   * 参考足球赛程表
   * 从飞鲸篮球API的3.赛程赛果 接口拿字段
2. **设计篮球联赛表**
   * 看看能不能和足球联赛表兼容，不能就重新设计一个
   * 飞鲸 9.联赛/杯赛资料 这个接口
3. **篮球球队表**
   * 飞鲸 12.球队资料



* 聊天室 删除单条消息

* 弹幕实现

* 机器人 进聊天室 （为了炒直播间）

* 敏感字未屏蔽 （感觉可以用es做，但暂时不做）

测试站执行除查询外的操作 要给运维





```php
APP_DEBUG = true

[APP]
DEFAULT_TIMEZONE = Asia/Shanghai

[LANG]
default_lang = zh-cn
[JWT]
SECRET=77cbfde72aa5189814037c569b812086
refresh_ttl=864000

[DATABASE]
TYPE = mysql
HOSTNAME = 127.0.0.1
DATABASE = hainiu
USERNAME = root
PASSWORD = password
HOSTPORT = 3306
CHARSET = utf8
DEBUG = true

[DATABASE]
TYPE = mysql
HOSTNAME = 43.135.76.182
DATABASE = db_hainiu
USERNAME = u_hainiu
PASSWORD = hainiu@2022
HOSTPORT = 3306
CHARSET = utf8
DEBUG = true
  
```

```
//        $log['log_url'] = $_SERVER['REQUEST_SCHEME'].'://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
        $log['log_url'] = 'https://'.$_SERVER['HTTP_HOST'].$_SERVER['REQUEST_URI'];
```



```
<?php

namespace app\api\model;

use app\common\controller\Enum;
use think\db\exception\DataNotFoundException;
use think\db\exception\DbException;
use think\db\exception\ModelNotFoundException;
use think\facade\Log;
use think\Model;
use hg\apidoc\annotation\Field;
use hg\apidoc\annotation\WithoutField;
use hg\apidoc\annotation\AddField;
use hg\apidoc\annotation\Param;

class ScheduleMatchModel extends Model
{
    // 设置当前模型对应的完整数据表名称
    protected $table = 'hn_schedule';
    protected $pageSize;
    protected $page;
    protected $startTime = " 00:00:00";
    protected $endTime = " 23:59:59";

    // 设置字段信息
    protected $schema = [
        "id"             => "int",
        "matchId"        => "int",
        "color"          => "string",
        "kind"           => "int",
        "leagueId"       => "int",
        "leagueEn"       => "string",
        "leagueEnShort"  => "string",
        "leagueChsShort" => "string",
        "leagueChtShort" => "string",
        "subLeagueId"    => "string",
        "subLeagueEn"    => "string",
        "subLeagueChs"   => "string",
        "subLeagueCht"   => "string",
        "matchTime"      => "string",
        "startTime"      => "string",
        "homeEn"         => "string",
        "homeChs"        => "string",
        "homeCht"        => "string",
        "awayEn"         => "string",
        "awayChs"        => "string",
        "awayCht"        => "string",
        "homeId"         => "int",
        "awayId"         => "int",
        "state"          => "int",
        "homeScore"      => "int",
        "awayScore"      => "int",
        "homeHalfScore"  => "int",
        "awayHalfScore"  => "int",
        "homeRed"        => "int",
        "awayRed"        => "int",
        "homeYellow"     => "int",
        "awayYellow"     => "int",
        "homeCorner"     => "int",
        "awayCorner"     => "int",
        "homeRankEn"     => "string",
        "homeRankCn"     => "string",
        "awayRankEn"     => "string",
        "awayRankCn"     => "string",
        "isNeutral"      => "string",
        "hasLineup"      => "string",
        "season"         => "string",
        "groupId"        => "string",
        "roundEn"        => "string",
        "roundCn"        => "string",
        "grouping"       => "string",
        "locationEn"     => "string",
        "locationCn"     => "string",
        "weatherEn"      => "string",
        "weatherCn"      => "string",
        "temp"           => "string",
        "explainEn"      => "string",
        "explainCn"      => "string",
        "extraExplain"   => "string",
        "isHidden"       => "string",
        "updateTime"     => "string",
        "matchStartTime" => "int",
    ];


    /**
     * @Field("matchId,homeChs,awayChs,leagueChsShort,matchTime,state")
     */
    public function getMatchByLeaguesId()
    {
        $params = request()->post();

        $whereBtw = $this->startEndTime($params['day']);

        if (!empty($params['leagueId']) && $params['leagueId'] != 300000) $league_id['leagueId'] = $params['leagueId'];
        if (!empty($params['type'])) $league_id['leagueType'] = $params['type'];
        $whereIn = "0,1,2,3,4,5";

        $scheduleModel = new ScheduleMatchModel();

        if (!empty($league_id)) {
            $match_info = $scheduleModel->where($league_id)->whereIn('state', $whereIn)->whereBetween('matchStartTime', $whereBtw)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        } else {
            $match_info = $scheduleModel->whereIn('state', $whereIn)->whereBetween('matchStartTime', $whereBtw)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        }

        return $match_info;
    }

    /**
     * @Field("matchId,homeChs,awayChs,leagueChsShort,matchTime,state")
     */
    public function getMatchByDay()
    {
        $params = request()->post();
        if (empty($params['day'])) return [];
        $start = $params['day'];
        $start = strtotime($start);
        $end = $start + 86399;
        $where_between = [$start, $end];
        if (!empty($params['leagueId']) && $params['leagueId'] != 300000) $league_id['leagueId'] = $params['leagueId'];
        if (!empty($params['type'])) $league_id['leagueType'] = $params['type'];
        $whereIn = "0,1,2,3,4,5";

        $scheduleModel = new ScheduleMatchModel();

        if (!empty($league_id)) {
            $match_info = $scheduleModel->where($league_id)->whereIn('state', $whereIn)->whereBetween('matchStartTime', $where_between)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        } else {
            $match_info = $scheduleModel->whereIn('state', $whereIn)->whereBetween('matchStartTime', $where_between)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        }

        return $match_info;
    }

    public function lists($data)
    {
        $this->pageSize = $data['pageSize'];
        $this->page = $data['pageNum'];
        $whereBtw = $data['whereBtw'];
        $whereIn = "0,1,2,3,4,5,-1"; // 比赛状态 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        $hierarchy = $data['hierarchy']; // 联赛级别
        $leagueId = $data['leagueId'];
        $leagueType = $data['leagueType'];
        $day = $data['day'];
        $playing = $data['playing'];

        if (!empty($leagueId)) $whereType['sc.leagueId'] = $leagueId;
        if (!empty($leagueType)) $whereType['sc.leagueType'] = $leagueType;

        $fields = ['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime',
            'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore',
            'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo',
            'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore',
            'sc.awayHalfScore', 'sc.startTime', 'le.hierarchy'];
        $order = ['sc.matchStartTime' => "ASC"];

        // playing参数为比赛状态(schedule表中的state) 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        // -10:取消 -11:待定 -12:腰斩 -13:中断 -14:推迟
        if (!empty($playing)) {
            if ($playing == Enum::MATCH_NOT_START) $whereIn = "0"; // 未开始的比赛：1000
            if ($playing == Enum::MATCH_IN_PROGRESS) $whereIn = "1,2,3,4,5";  //   进行中：2000
            if ($playing == Enum::MATCH_COMPLETED) $whereIn = '-1'; //  已结束：3000
        }
        if (empty($whereType)) {
            $whereType = array();
        }
        try {
            // 指定日期 赛事-赛程模块指定日期时用
            if (!empty($day)) {
                $res = $this->scBtwSql($hierarchy, $whereIn, $whereType, $whereBtw, $fields, $order);
                // 如果查询日期为今天 ，会拼接上昨天还未结束的比赛
                if ($day == date('Y-m-d') && empty($playing)) {
                    $whereBtw = $this->startEndTime(date("Y-m-d",strtotime("-1 day")));
                    $whereIn = "1,2,3,4,5";
                    $stillOnMatch = $this->scBtwSql($hierarchy, $whereIn, $whereType, $whereBtw, $fields, $order);
                    if (!empty($stillOnMatch)) {
                        $todayMath = $res->toArray();
                        $stillOnMatch = $stillOnMatch->toArray();
                        foreach ($stillOnMatch['data'] as $datum) {
                            array_unshift($todayMath['data'], $datum);
                        }
                        return $todayMath;
                    }
                }
            }
            // 赛事推荐模块用，不传指定日期
            else {
                if ($playing == Enum::MATCH_NOT_START) {
                    $order = ['sc.matchStartTime' => "ASC"];
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $fields, $order);
                }
                // 查询正在进行中的比赛，不用加时间条件
                if ($playing == Enum::MATCH_IN_PROGRESS) {
                    $order = ['sc.matchStartTime' => "ASC"];
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $fields, $order);
                }
                // 查询结束的比赛
                if ($playing == Enum::MATCH_COMPLETED) {
                    $order = ['sc.matchStartTime' => "DESC"];
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $fields, $order);
                }
            }

            if (!empty($res)) return $res->toArray();

            return $res;

        } catch (DbException $e) {
            return ['code' => Enum::MATCH_LIST_EXCEPTION, 'msg' => $e->getMessage()];
        }
    }

    /**
     * @param $hierarchy string 联赛级别 1 2 3
     * @param $whereIn string 赛程表的状态 进行中或已结束
     * @param $whereType array 指定赛程表的ID和类型
     * @param $fields array 查询的字段
     * @param $order array 排序
     * @return mixed
     */
    public function scSql(string $hierarchy, string $whereIn, array $whereType, array $fields, array $order)
    {
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->alias('sc')
            // team表的teamId(球队ID)关联sc表的homeId(主队ID)与awayId(客队ID)
            ->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')
            // leagues联赛表
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            // 赛程表的状态为进行中或已结束 -> le.hierarchy 联赛的赛事级别为 1、2 -> 指定赛程表的ID和类型
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->where($whereType)
            ->field($fields)->order($order)
            ->paginate([
                'list_rows' => $this->pageSize,
                'page'      => $this->page,
            ]);

        return $res;
    }

    /**
     * @param $hierarchy string 联赛级别 1 2 3
     * @param $whereIn string 赛程表的状态 进行中或已结束
     * @param $whereType array 指定赛程表的ID和类型
     * @param $where array 赛程开始和结束时间
     * @param $fields array 查询的字段
     * @param $order array 排序
     * @return mixed
     */
    public function scBtwSql(string $hierarchy, string $whereIn, array $whereType, array $where, array $fields, array $order)
    {
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->alias('sc')
            // team表的teamId(球队ID)关联sc表的homeId(主队ID)与awayId(客队ID)
            ->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')
            // leagues联赛表
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            // 赛程表的状态为进行中或已结束 -> le.hierarchy 联赛的赛事级别为 1、2 -> 指定赛程表的ID和类型
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->where($whereType)
            // 赛程开始和结束时间
            ->whereBetween('sc.matchStartTime', $where)
            ->field($fields)->order($order)
            ->paginate([
                'list_rows' => $this->pageSize,
                'page'      => $this->page,
            ]);
//        echo $scheduleModel->getLastSql();exit;
        return $res;
    }

    public function matchLists($member_id = '')
    {
        $params = request()->post();
        $page_size = $params['pageSize'] ?? 100;
        $page = $params['pageNum'] ?? 1;

        $time = date("Y-m-d", time());
        if (!empty($params['day'])) $time = trim($params['day']);

        $start = $time . " 00:00:00";
        $end = $time . " 23:59:59";
        $start = strtotime($start);
        $end = strtotime($end);
        $where = [$start, $end];

        $scheduleModel = new ScheduleMatchModel();
        $whereIn = "0";

        if (!empty($params['leagueId'])) $whereType['sc.leagueId'] = $params['leagueId'];
        if (!empty($params['leagueType'])) $whereType['sc.leagueType'] = $params['leagueType'];

        try {

            if (!empty($whereType)) {
                if (!empty($params['day'])) {
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->where($whereType)->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                } else {
                    $where = "matchStartTime >= " . time();
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->where($whereType)->where($where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                }

            } else {
                if (!empty($params['day'])) {
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                } else {
                    $res = [];
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                }

            }
            if (!empty($res)) return $res->toArray();

            return $res;
        } catch (DbException $e) {
            return ['code' => 2301, 'msg' => $e->getMessage()];
        }
    }

    public function match($data)
    {
        $whereIn = '0,1,2,3,4,5';
        $whereBtw = $data['whereBtw'];
        $whereInSc = '0,1,2,3,4,5,-1';
        $leagueType['leagueType'] = 1;
        $hierarchy['hierarchy'] = 1; // 赛事级别

        // playing参数为比赛状态(schedule表中的state) 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        if (!empty($data['playing'])) {
            if ($data['playing'] == '2000') $whereIn = "1,2,3,4,5";
            if ($data['playing'] == '1000') $whereIn = '0';
            if ($data['playing'] == '3000') $whereIn = '0,1,2,3,4,5';
        }

        $scheduleModel = new ScheduleMatchModel();

        $res = $scheduleModel->whereIn('state', $whereInSc)
            ->whereBetween('matchStartTime', $whereBtw)->where($leagueType)
            ->field(['matchId'])->count();

        unset($whereBtw);
        $whereBtw = [$data['whereBtw'][0], $data['whereBtw'][1] + 518400]; // 加6天

        $lists = $scheduleModel->alias('sc')
            ->join('team te', 'te.teamId = sc.homeId')
            ->join('team tm', 'tm.teamId = sc.awayId')
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->whereBetween('sc.matchStartTime', $whereBtw)
            ->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs',
                'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime',
                'sc.leagueChsShort', 'sc.technicCount', 'sc.homeScore', 'sc.awayScore',
                'sc.isPosition', 'sc.leagueId', 'te.logo as homeLogo', 'tm.logo as awayLogo',
                'le.leagueLogo', 'le.hierarchy', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow',
                'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])
            ->order('sc.matchStartTime', 'ASC')->limit(20)->select()->all();

        $result['total'] = 0;
        if (!empty($res)) $result['total'] = $res;

        $result['list'] = null;
        if (!empty($lists)) $result['list'] = $lists;

        return $result;
    }

    public function followLists($match_id)
    {
        $params = request()->post();
        $page_size = $params['pageSize'] ?? 10;
        $page = $params['pageNum'] ?? 1;
        if (!empty($params['match_status']) && $params['match_status'] == '3000') {
            $res = ScheduleMatchModel::whereIn('matchId', $match_id)->field(['sc.color', 'color', 'matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'homeScore', 'awayScore', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeRankCn', 'awayRankCn', 'follow as reserveNum', 'startTime', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeHalfScore', 'awayHalfScore'])->order(['state' => 'DESC', 'matchStartTime' => 'DESC'])->paginate([
                'list_rows' => $page_size,
                'page'      => $page,
            ]);
        } else {
            $res = ScheduleMatchModel::whereIn('matchId', $match_id)->field(['color', 'matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'homeScore', 'awayScore', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeRankCn', 'awayRankCn', 'follow as reserveNum', 'startTime', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeHalfScore', 'awayHalfScore'])->order(['state' => 'DESC', 'matchStartTime' => 'AEC'])->paginate([
                'list_rows' => $page_size,
                'page'      => $page,
            ]);
        }

        return $res->toArray();
    }

    public function isH5()
    {
        //全部变成小写字母
        $agent = strtolower($_SERVER['HTTP_USER_AGENT']);
        if (strpos($agent, 'iphone') !== false || strpos($agent, 'ipad') !== false) {
            $device = 'IOS';
        } elseif (strpos($agent, 'android') !== false) {
            $device = 'Android';
        } elseif (strpos($agent, 'windows') !== false) {
            $device = 'PC';
            if (IS_MOBILE) $device = 'H5';
        } else {
            $device = 'PC';
            if (IS_MOBILE) $device = 'H5';
        }
        return $device;
    }

    public function startEndTime($day)
    {
        if (!empty($day)) {
            $date = $day;
        } else {
            $date = date("Y-m-d", time());
        }
        $start = strtotime($date . $this->startTime);
        $end = strtotime($date . $this->endTime);

        return [$start, $end];
    }

    public function getMatch()
    {
        $params = request()->post();

        if (empty($params['match_id'])) return [];
        $match_id = $params['match_id'];
        $match_info = ScheduleMatchModel::where('matchId', $match_id)->field(['matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'technicCount', 'homeScore', 'awayScore', 'locationCn', 'weatherCn', 'temp'])->find();
        if ($match_info) return $match_info;
        return [];
    }

    public function matchInfo($matchId)
    {
        $where['sc.matchId'] = $matchId;
        $res = ScheduleMatchModel::alias('sc')
            ->join('team th', 'sc.homeId = th.teamId')
            ->join('team ta', 'sc.awayId = ta.teamId')
            ->where($where)
            ->field(['th.coachCn as homeCoachCn', 'ta.coachCn as awayCoachCn',
                'th.nameChs as homeNameChs',
                'ta.nameChs as awayNameChs',
                'homeId', 'awayId'])
            ->find();
        if (empty($res)) return null;
        return $res;
    }


}
```

```
<?php

namespace app\api\model;

use app\common\controller\Enum;
use think\db\exception\DataNotFoundException;
use think\db\exception\DbException;
use think\db\exception\ModelNotFoundException;
use think\facade\Log;
use think\Model;
use hg\apidoc\annotation\Field;
use hg\apidoc\annotation\WithoutField;
use hg\apidoc\annotation\AddField;
use hg\apidoc\annotation\Param;

class ScheduleMatchModel extends Model
{
    // 设置当前模型对应的完整数据表名称
    protected $table = 'hn_schedule';
    protected $pageSize;
    protected $page;
    protected $startTime = " 00:00:00";
    protected $endTime = " 23:59:59";

    // 设置字段信息
    protected $schema = [
        "id"             => "int",
        "matchId"        => "int",
        "color"          => "string",
        "kind"           => "int",
        "leagueId"       => "int",
        "leagueEn"       => "string",
        "leagueEnShort"  => "string",
        "leagueChsShort" => "string",
        "leagueChtShort" => "string",
        "subLeagueId"    => "string",
        "subLeagueEn"    => "string",
        "subLeagueChs"   => "string",
        "subLeagueCht"   => "string",
        "matchTime"      => "string",
        "startTime"      => "string",
        "homeEn"         => "string",
        "homeChs"        => "string",
        "homeCht"        => "string",
        "awayEn"         => "string",
        "awayChs"        => "string",
        "awayCht"        => "string",
        "homeId"         => "int",
        "awayId"         => "int",
        "state"          => "int",
        "homeScore"      => "int",
        "awayScore"      => "int",
        "homeHalfScore"  => "int",
        "awayHalfScore"  => "int",
        "homeRed"        => "int",
        "awayRed"        => "int",
        "homeYellow"     => "int",
        "awayYellow"     => "int",
        "homeCorner"     => "int",
        "awayCorner"     => "int",
        "homeRankEn"     => "string",
        "homeRankCn"     => "string",
        "awayRankEn"     => "string",
        "awayRankCn"     => "string",
        "isNeutral"      => "string",
        "hasLineup"      => "string",
        "season"         => "string",
        "groupId"        => "string",
        "roundEn"        => "string",
        "roundCn"        => "string",
        "grouping"       => "string",
        "locationEn"     => "string",
        "locationCn"     => "string",
        "weatherEn"      => "string",
        "weatherCn"      => "string",
        "temp"           => "string",
        "explainEn"      => "string",
        "explainCn"      => "string",
        "extraExplain"   => "string",
        "isHidden"       => "string",
        "updateTime"     => "string",
        "matchStartTime" => "int",
    ];


    /**
     * @Field("matchId,homeChs,awayChs,leagueChsShort,matchTime,state")
     */
    public function getMatchByLeaguesId()
    {
        $params = request()->post();

        $whereBtw = $this->startEndTime($params['day']);

        if (!empty($params['leagueId']) && $params['leagueId'] != 300000) $league_id['leagueId'] = $params['leagueId'];
        if (!empty($params['type'])) $league_id['leagueType'] = $params['type'];
        $whereIn = "0,1,2,3,4,5";

        $scheduleModel = new ScheduleMatchModel();

        if (!empty($league_id)) {
            $match_info = $scheduleModel->where($league_id)->whereIn('state', $whereIn)->whereBetween('matchStartTime', $whereBtw)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        } else {
            $match_info = $scheduleModel->whereIn('state', $whereIn)->whereBetween('matchStartTime', $whereBtw)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        }

        return $match_info;
    }

    /**
     * @Field("matchId,homeChs,awayChs,leagueChsShort,matchTime,state")
     */
    public function getMatchByDay()
    {
        $params = request()->post();
        if (empty($params['day'])) return [];
        $start = $params['day'];
        $start = strtotime($start);
        $end = $start + 86399;
        $where_between = [$start, $end];
        if (!empty($params['leagueId']) && $params['leagueId'] != 300000) $league_id['leagueId'] = $params['leagueId'];
        if (!empty($params['type'])) $league_id['leagueType'] = $params['type'];
        $whereIn = "0,1,2,3,4,5";

        $scheduleModel = new ScheduleMatchModel();

        if (!empty($league_id)) {
            $match_info = $scheduleModel->where($league_id)->whereIn('state', $whereIn)->whereBetween('matchStartTime', $where_between)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        } else {
            $match_info = $scheduleModel->whereIn('state', $whereIn)->whereBetween('matchStartTime', $where_between)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        }

        return $match_info;
    }

    public function lists($data)
    {
        $this->pageSize = $data['pageSize'];
        $this->page = $data['pageNum'];
        $whereBtw = $data['whereBtw'];
        $whereIn = "0,1,2,3,4,5,-1"; // 比赛状态 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        $hierarchy = $data['hierarchy']; // 联赛级别
        $leagueId = $data['leagueId'];
        $leagueType = $data['leagueType'];
        $day = $data['day'];
        $playing = $data['playing'];

        if (!empty($leagueId)) $whereType['sc.leagueId'] = $leagueId;
        if (!empty($leagueType)) $whereType['sc.leagueType'] = $leagueType;

        $fields = ['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime',
            'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore',
            'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo',
            'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore',
            'sc.awayHalfScore', 'sc.startTime', 'le.hierarchy'];
        $order = ['sc.matchStartTime' => "ASC"];

        // playing参数为比赛状态(schedule表中的state) 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        // -10:取消 -11:待定 -12:腰斩 -13:中断 -14:推迟
        if (!empty($playing)) {
            if ($playing == Enum::MATCH_NOT_START) $whereIn = "0"; // 未开始的比赛：1000
            if ($playing == Enum::MATCH_IN_PROGRESS) $whereIn = "1,2,3,4,5";  //   进行中：2000
            if ($playing == Enum::MATCH_COMPLETED) $whereIn = '-1'; //  已结束：3000
        }
        if (empty($whereType)) {
            $whereType = array();
        }
        try {
            // 指定日期 赛事-赛程模块指定日期时用
            if (!empty($day)) {
                $res = $this->scBtwSql($hierarchy, $whereIn, $whereType, $whereBtw, $fields, $order);
                // 如果查询日期为今天 ，会拼接上昨天还未结束的比赛
                if ($day == date('Y-m-d') && empty($playing)) {
                    $whereBtw = $this->startEndTime(date("Y-m-d",strtotime("-1 day")));
                    $whereIn = "1,2,3,4,5";
                    $stillOnMatch = $this->scBtwSql($hierarchy, $whereIn, $whereType, $whereBtw, $fields, $order);
                    if (!empty($stillOnMatch)) {
                        $todayMath = $res->toArray();
                        $stillOnMatch = $stillOnMatch->toArray();
                        foreach ($stillOnMatch['data'] as $datum) {
                            array_unshift($todayMath['data'], $datum);
                        }
                        return $todayMath;
                    }
                }
            }
            // 赛事推荐模块用，不传指定日期
            else {
                if ($playing == Enum::MATCH_NOT_START) {
                    $order = ['sc.matchStartTime' => "ASC"];
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $fields, $order);
                }
                // 查询正在进行中的比赛，不用加时间条件
                if ($playing == Enum::MATCH_IN_PROGRESS) {
                    $order = ['sc.matchStartTime' => "ASC"];
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $fields, $order);
                }
                // 查询结束的比赛
                if ($playing == Enum::MATCH_COMPLETED) {
                    $order = ['sc.matchStartTime' => "DESC"];
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $fields, $order);
                }
            }

            if (!empty($res)) return $res->toArray();

            return $res;

        } catch (DbException $e) {
            return ['code' => Enum::MATCH_LIST_EXCEPTION, 'msg' => $e->getMessage()];
        }
    }

    /**
     * @param $hierarchy string 联赛级别 1 2 3
     * @param $whereIn string 赛程表的状态 进行中或已结束
     * @param $whereType array 指定赛程表的ID和类型
     * @param $fields array 查询的字段
     * @param $order array 排序
     * @return mixed
     */
    public function scSql(string $hierarchy, string $whereIn, array $whereType, array $fields, array $order)
    {
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->alias('sc')
            // team表的teamId(球队ID)关联sc表的homeId(主队ID)与awayId(客队ID)
            ->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')
            // leagues联赛表
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            // 赛程表的状态为进行中或已结束 -> le.hierarchy 联赛的赛事级别为 1、2 -> 指定赛程表的ID和类型
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->where($whereType)
            ->field($fields)->order($order)
            ->paginate([
                'list_rows' => $this->pageSize,
                'page'      => $this->page,
            ]);

        return $res;
    }

    /**
     * @param $hierarchy string 联赛级别 1 2 3
     * @param $whereIn string 赛程表的状态 进行中或已结束
     * @param $whereType array 指定赛程表的ID和类型
     * @param $where array 赛程开始和结束时间
     * @param $fields array 查询的字段
     * @param $order array 排序
     * @return mixed
     */
    public function scBtwSql(string $hierarchy, string $whereIn, array $whereType, array $where, array $fields, array $order)
    {
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->alias('sc')
            // team表的teamId(球队ID)关联sc表的homeId(主队ID)与awayId(客队ID)
            ->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')
            // leagues联赛表
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            // 赛程表的状态为进行中或已结束 -> le.hierarchy 联赛的赛事级别为 1、2 -> 指定赛程表的ID和类型
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->where($whereType)
            // 赛程开始和结束时间
            ->whereBetween('sc.matchStartTime', $where)
            ->field($fields)->order($order)
            ->paginate([
                'list_rows' => $this->pageSize,
                'page'      => $this->page,
            ]);
//        echo $scheduleModel->getLastSql();exit;
        return $res;
    }

    public function matchLists($member_id = '')
    {
        $params = request()->post();
        $page_size = $params['pageSize'] ?? 100;
        $page = $params['pageNum'] ?? 1;

        $time = date("Y-m-d", time());
        if (!empty($params['day'])) $time = trim($params['day']);

        $start = $time . " 00:00:00";
        $end = $time . " 23:59:59";
        $start = strtotime($start);
        $end = strtotime($end);
        $where = [$start, $end];

        $scheduleModel = new ScheduleMatchModel();
        $whereIn = "0";

        if (!empty($params['leagueId'])) $whereType['sc.leagueId'] = $params['leagueId'];
        if (!empty($params['leagueType'])) $whereType['sc.leagueType'] = $params['leagueType'];

        try {

            if (!empty($whereType)) {
                if (!empty($params['day'])) {
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->where($whereType)->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                } else {
                    $where = "matchStartTime >= " . time();
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->where($whereType)->where($where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                }

            } else {
                if (!empty($params['day'])) {
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                } else {
                    $res = [];
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                }

            }
            if (!empty($res)) return $res->toArray();

            return $res;
        } catch (DbException $e) {
            return ['code' => 2301, 'msg' => $e->getMessage()];
        }
    }

    public function match($data)
    {
        $whereIn = '0,1,2,3,4,5';
        $whereBtw = $data['whereBtw'];
        $whereInSc = '0,1,2,3,4,5,-1';
        $leagueType['leagueType'] = 1;
        $hierarchy['hierarchy'] = 1; // 赛事级别

        // playing参数为比赛状态(schedule表中的state) 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        if (!empty($data['playing'])) {
            if ($data['playing'] == '2000') $whereIn = "1,2,3,4,5";
            if ($data['playing'] == '1000') $whereIn = '0';
            if ($data['playing'] == '3000') $whereIn = '0,1,2,3,4,5';
        }

        $scheduleModel = new ScheduleMatchModel();

        $res = $scheduleModel->whereIn('state', $whereInSc)
            ->whereBetween('matchStartTime', $whereBtw)->where($leagueType)
            ->field(['matchId'])->count();

        unset($whereBtw);
        $whereBtw = [$data['whereBtw'][0], $data['whereBtw'][1] + 518400]; // 加6天

        $lists = $scheduleModel->alias('sc')
            ->join('team te', 'te.teamId = sc.homeId')
            ->join('team tm', 'tm.teamId = sc.awayId')
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->whereBetween('sc.matchStartTime', $whereBtw)
            ->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs',
                'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime',
                'sc.leagueChsShort', 'sc.technicCount', 'sc.homeScore', 'sc.awayScore',
                'sc.isPosition', 'sc.leagueId', 'te.logo as homeLogo', 'tm.logo as awayLogo',
                'le.leagueLogo', 'le.hierarchy', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow',
                'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])
            ->order('sc.matchStartTime', 'ASC')->limit(20)->select()->all();

        $result['total'] = 0;
        if (!empty($res)) $result['total'] = $res;

        $result['list'] = null;
        if (!empty($lists)) $result['list'] = $lists;

        return $result;
    }

    public function followLists($match_id)
    {
        $params = request()->post();
        $page_size = $params['pageSize'] ?? 10;
        $page = $params['pageNum'] ?? 1;
        if (!empty($params['match_status']) && $params['match_status'] == '3000') {
            $res = ScheduleMatchModel::whereIn('matchId', $match_id)->field(['sc.color', 'color', 'matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'homeScore', 'awayScore', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeRankCn', 'awayRankCn', 'follow as reserveNum', 'startTime', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeHalfScore', 'awayHalfScore'])->order(['state' => 'DESC', 'matchStartTime' => 'DESC'])->paginate([
                'list_rows' => $page_size,
                'page'      => $page,
            ]);
        } else {
            $res = ScheduleMatchModel::whereIn('matchId', $match_id)->field(['color', 'matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'homeScore', 'awayScore', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeRankCn', 'awayRankCn', 'follow as reserveNum', 'startTime', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeHalfScore', 'awayHalfScore'])->order(['state' => 'DESC', 'matchStartTime' => 'AEC'])->paginate([
                'list_rows' => $page_size,
                'page'      => $page,
            ]);
        }

        return $res->toArray();
    }

    public function isH5()
    {
        //全部变成小写字母
        $agent = strtolower($_SERVER['HTTP_USER_AGENT']);
        if (strpos($agent, 'iphone') !== false || strpos($agent, 'ipad') !== false) {
            $device = 'IOS';
        } elseif (strpos($agent, 'android') !== false) {
            $device = 'Android';
        } elseif (strpos($agent, 'windows') !== false) {
            $device = 'PC';
            if (IS_MOBILE) $device = 'H5';
        } else {
            $device = 'PC';
            if (IS_MOBILE) $device = 'H5';
        }
        return $device;
    }

    public function startEndTime($day)
    {
        if (!empty($day)) {
            $date = $day;
        } else {
            $date = date("Y-m-d", time());
        }
        $start = strtotime($date . $this->startTime);
        $end = strtotime($date . $this->endTime);

        return [$start, $end];
    }

    public function getMatch()
    {
        $params = request()->post();

        if (empty($params['match_id'])) return [];
        $match_id = $params['match_id'];
        $match_info = ScheduleMatchModel::where('matchId', $match_id)->field(['matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'technicCount', 'homeScore', 'awayScore', 'locationCn', 'weatherCn', 'temp'])->find();
        if ($match_info) return $match_info;
        return [];
    }

    public function matchInfo($matchId)
    {
        $where['sc.matchId'] = $matchId;
        $res = ScheduleMatchModel::alias('sc')
            ->join('team th', 'sc.homeId = th.teamId')
            ->join('team ta', 'sc.awayId = ta.teamId')
            ->where($where)
            ->field(['th.coachCn as homeCoachCn', 'ta.coachCn as awayCoachCn',
                'th.nameChs as homeNameChs',
                'ta.nameChs as awayNameChs',
                'homeId', 'awayId'])
            ->find();
        if (empty($res)) return null;
        return $res;
    }


}
```

```
<?php
// +----------------------------------------------------------------------
// | ThinkPHP [ WE CAN DO IT JUST THINK IT ]
// +----------------------------------------------------------------------
// | Copyright (c) 2006-2018 http://thinkphp.cn All rights reserved.
// +----------------------------------------------------------------------
// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )
// +----------------------------------------------------------------------
// | Author: liu21st <liu21st@gmail.com>
// +----------------------------------------------------------------------
namespace app\worker\controller;

use app\api\model\MuteRoomModel;
use app\common\controller\Enum;
use app\worker\model\MemberModel;
use app\worker\model\ScheduleMatchModel;
use app\worker\model\SystemMessageModel;
use GatewayWorker\Lib\Gateway;
use think\facade\Cache;
use think\facade\Config;
use think\facade\Log;
use think\worker\Application;
use Workerman\Lib\Timer;
use Workerman\Worker;

/**
 * Worker 命令行服务类
 */
class Events
{
    /**
     * onWorkerStart 事件回调
     * 当businessWorker进程启动时触发。每个进程生命周期内都只会触发一次
     *
     * @access public
     * @param \Workerman\Worker $businessWorker
     * @return void
     */
    public static function onWorkerStart(Worker $businessWorker)
    {
        $app = new Application;
        $app->initialize();
        //只在进程1进行定时任务
//        if ($businessWorker->id === 1) {
//            //业务定时器
//            Events::updateToday();
//        }
    }

    /**
     * onConnect 事件回调
     * 当客户端连接上gateway进程时(TCP三次握手完毕时)触发
     *
     * @access public
     * @param int $client_id
     * @return void
     */
    public static function onConnect($client_id)
    {
//        Gateway::sendToClient($client_id, json_encode(array(
//            'type'      => 'init',
//            'client_id' => $client_id,
//            'timeStemp' => time(),
//        )));
    }

    /**
     * onWebSocketConnect 事件回调
     * 当客户端连接上gateway完成websocket握手时触发
     *
     * @param integer $client_id 断开连接的客户端client_id
     * @param mixed $data
     * @return void
     */
    public static function onWebSocketConnect($client_id, $data)
    {
        var_export($data);
    }

    /**
     * onMessage 事件回调
     * 当客户端发来数据(Gateway进程收到数据)后触发
     *
     * @access public
     * @param int $client_id
     * @param mixed $data
     * @return void
     */
    public static function onMessage($client_id, $data)
    {
        $data = json_decode($data, true);
        if (!empty($data['member_id'])) {
            $member_id = $data['member_id'];
            $member = Cache::store('redis')->get('memberInfo' . $member_id);
            if (!empty($member)) $member = json_decode($member, true);
            if (empty($member)) {
                $member = Events::memberInfo($member_id);
                if (!empty($member)) {
                    $data['userInfo'] = $member;
                    Cache::store('redis')->set('memberInfo' . $member_id, json_encode($member), 3600);
                }
            }
        }

        $room_id = $data['room_id'] ?? '';

        // 根据类型执行不同的业务
        switch ($data['type']) {
            // 客户端回应服务端的心跳
            case 'ping':
                break;
            // 客户端登录 message格式: {type:login, name:xx, room_id:1} ，添加到客户端，广播给所有客户端xx进入聊天室
            case Enum::CHAT_LOGIN:
                Events::sendSystemMessage($client_id);
                if (!empty($member) && !empty($member_id)) {
                    Gateway::bindUid($client_id, $member['member_id']);
                    $message['member_type'] = 'member';
                    $message['member_id'] = $member['member_id'];
                    $message['nickname'] = $member['nickname'];
                    $message['avatar'] = $member['avatar'];
                } else if (!empty($member_id) && empty($member)) { // 如果传了member_id但查不到member，1.可能是数据库链接问题 2.可能是是没有此用户(一般不可能)
                    $mess['content'] = "没有查到member数据";
                    $mess['member_type'] = "no_member";
                    $mess['type'] = "2010";
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                } else {
                    $message['nickname'] = '游客_' . Events::checkNo();
                    $message['member_type'] = 'visitor';
                    Cache::store('redis')->set('visitorMember' . $client_id, $message['nickname']);
                }

                $message['content'] = $data;
                $message['type'] = Enum::CHAT_LOGIN;

                if (!empty($room_id)) {
                    Gateway::joinGroup($client_id, $room_id);
                    Gateway::sendToGroup($room_id, json_encode($message));
                    unset($message);
                }
                break;
            case Enum::CHAT_SEND_MESSAGE:
                if (empty($member)) {
                    $mess['content'] = "请先登录";
                    $mess['member_type'] = "no_login";
                    $mess['type'] = "2010";
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                }

                $is_allow = Cache::store('redis')->get('allow_send' . $member['member_id']);
                if (!empty($is_allow)) {
                    $mess['content'] = "两秒内只能发一次信息";
                    $mess['member_type'] = "no_allow";
                    $mess['type'] = "2010";
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                }
                Cache::store('redis')->set('allow_send' . $member['member_id'], $member['member_id'], 2);

                // 判断用户是否被禁言
                $model = new MuteRoomModel();
                $isForbid = $model->getMute($member['member_id']);
                if ($isForbid['status'] == Enum::MUTE_STATUS_NORMAL) {
                    $mess['content'] = "用户已被禁言";
                    $mess['member_id'] = $member['member_id'];
                    $mess['nickname'] = $member['nickname'];
                    $mess['type'] = Enum::CHAT_MUTE_NOTICE;
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                }

                $msg = $data['msg'] ?? '';
                // TODO 要设置过期时间
                $msgCount = (Cache::store('redis')->hLen("chatroom:history:" . $room_id)) + 1;
                Cache::store('redis')->hSet("chatroomHistory:" . $room_id, $msgCount, $member['member_id'] . ":" . $msg);

                $data['end_time'] = date('Y-m-d H:i:s', time());
                $send_data['content'] = $data;
                $send_data['member_id'] = $member['member_id'];
                $send_data['level'] = $member['level'];
                $send_data['nickname'] = $member['nickname'];
                $send_data['avatar'] = $member['avatar'];
                $send_data['type'] = Enum::CHAT_SEND_MESSAGE;
                $send_data['member_type'] = 'member';
                $send_data['msg_count'] = $msgCount;

                if (!empty($room_id)) Gateway::sendToGroup($room_id, json_encode($send_data));
                unset($send_data);
                break;
            case '4000':
                //进球事件
                Gateway::joinGroup($client_id, 'match4000');
                break;
            case '5011':
                //重启系统消息任务列表
//                Events::systemMessage();
                break;
            default :
                return;
        }
    }

    /**
     * onClose 事件回调 当用户断开连接时触发的方法
     *
     * @param integer $client_id 断开连接的客户端client_id
     * @return void
     */
    public static function onClose($client_id)
    {
        Cache::store('redis')->delete('visitorMember' . $client_id);
//        GateWay::sendToAll("client[$client_id] logout\n");
    }

    /**
     * onWorkerStop 事件回调
     * 当businessWorker进程退出时触发。每个进程生命周期内都只会触发一次。
     *
     * @param \Workerman\Worker $businessWorker
     * @return void
     */
    public static function onWorkerStop(Worker $businessWorker)
    {
//        echo "WorkerStop\n";
    }


    public static function memberInfo($member_id)
    {
        $member = new MemberModel();
        $member_info = $member->getMember($member_id);

        if (!empty($member_info)) {
            return $member_info;
        } else {
            return null;
        }
    }

    public static function checkNo()
    {
        $room_id = mt_rand(500000, 799999);
        $num = Cache::store('redis')->SCARD('visitor_list');
        if ($num > 299999) Cache::store('redis')->delete('visitor_list');
        $is = Cache::store('redis')->SISMEMBER('visitor_list', $room_id);
        if (!$is) {
            Cache::store('redis')->SADD('visitor_list', $room_id);
            return $room_id;
        }
        return Events::checkNo();
    }

    public static function checkNoRobot()
    {
        $room_id = mt_rand(800000, 999999);
        $num = Cache::store('redis')->SCARD('robot_visitor_list');
        if ($num > 199999) Cache::store('redis')->delete('robot_visitor_list');
        $is = Cache::store('redis')->SISMEMBER('robot_visitor_list', $room_id);
        if (!$is) {
            Cache::store('redis')->SADD('robot_visitor_list', $room_id);
            return $room_id;
        }
        return Events::checkNo();
    }

    public static function sendSystemMessage($client_id)
    {

        $system_data = Cache::store('redis')->get('sendSystemMessage');
        if (!empty($system_data)) $system_lists = json_decode($system_data, true);
        if (empty($system_lists)) {
            $system_message = new SystemMessageModel();
            $system_lists = $system_message->lists();
            Cache::store('redis')->set('sendSystemMessage', json_encode($system_lists), 86400);
        }

        if (!empty($system_lists[0])) {
            $data['type'] = '1120';
            $data['content']['msg'] = $system_lists[0]['content'];
            Gateway::sendToClient($client_id, json_encode($data));
        }
    }

    public static function updateToday()
    {
        $time_task_system = 120;
        Timer::add($time_task_system, function () {
            $url = Config::get('match.url');
            $api = '/football/today.aspx';
            $key = Config::get('match.key');
            $api_url = $url . $api . '?key=' . $key;
            $data = Events::curlGetData($api_url);
            $data = json_decode($data, true);
            if (empty($data['matchList'])) return '数据为空';
            $scheduleModel = new ScheduleMatchModel();
            $res = $scheduleModel->addSchedule($data);
            return json($res);
        });
    }


    public static function curlGetData($url)
    {

        $header = array(
            'Accept: application/json',
        );
        $curl = curl_init();
        //设置抓取的url
        curl_setopt($curl, CURLOPT_URL, $url);
        //设置头文件的信息作为数据流输出
        curl_setopt($curl, CURLOPT_HEADER, 0);
        // 超时设置,以秒为单位
        curl_setopt($curl, CURLOPT_TIMEOUT, 50000);
        // 超时设置，以毫秒为单位
        curl_setopt($curl, CURLOPT_TIMEOUT_MS, 50000);
        // 设置请求头
        curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
        //设置获取的信息以文件流的形式返回，而不是直接输出。
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
        //执行命令
        $data = curl_exec($curl);
        // 显示错误信息
        if (curl_error($curl)) {
            return curl_error($curl);
        } else {
            // 打印返回的内容
            curl_close($curl);
            return $data;
        }
    }

    public static function systemMessage()
    {

        $time_task_system = 60;
        Timer::add($time_task_system, function () {
            $system_lists = Cache::store('redis')->get('system_lists');
            if (empty($system_lists)) {
                $system_message = new SystemMessageModel();
                $system_lists = $system_message->lists();
                Cache::store('redis')->set('system_lists', json_encode($system_lists));
                if (!empty($system_lists[0])) {
                    foreach ($system_lists as $k => $v) {
                        if (!empty($v['cycle']) && $v['status'] == 2) {
                            $is_run = Cache::store('redis')->get('system_lists_timer_id' . $v['id']);
                            if (!empty($is_run)) Timer::del($is_run);

                            $v['cycle'] = intval($v['cycle']);
                            $time_interval = $v['cycle'];
                            $timer_id = Timer::add($time_interval, function () use ($k, $v) {
                                $data['type'] = '1120';
                                $data['content']['msg'] = $v['content'];
                                Gateway::sendToAll(json_encode($data));
                                unset($data);
                            });
                            unset($content);
                            Cache::store('redis')->set('system_lists_timer_id' . $v['id'], $timer_id);
                        }
                    }
                }
            }
        });
    }
}


```



```
<?php
// +----------------------------------------------------------------------
// | ThinkPHP [ WE CAN DO IT JUST THINK IT ]
// +----------------------------------------------------------------------
// | Copyright (c) 2006-2018 http://thinkphp.cn All rights reserved.
// +----------------------------------------------------------------------
// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )
// +----------------------------------------------------------------------
// | Author: liu21st <liu21st@gmail.com>
// +----------------------------------------------------------------------
namespace app\worker\controller;

use app\api\model\MuteRoomModel;
use app\common\controller\Enum;
use app\worker\model\MemberModel;
use app\worker\model\ScheduleMatchModel;
use app\worker\model\SystemMessageModel;
use GatewayWorker\Lib\Gateway;
use think\facade\Cache;
use think\facade\Config;
use think\facade\Log;
use think\worker\Application;
use Workerman\Lib\Timer;
use Workerman\Worker;

/**
 * Worker 命令行服务类
 */
class Events
{
    /**
     * onWorkerStart 事件回调
     * 当businessWorker进程启动时触发。每个进程生命周期内都只会触发一次
     *
     * @access public
     * @param \Workerman\Worker $businessWorker
     * @return void
     */
    public static function onWorkerStart(Worker $businessWorker)
    {
        $app = new Application;
        $app->initialize();
        //只在进程1进行定时任务
//        if ($businessWorker->id === 1) {
//            //业务定时器
//            Events::updateToday();
//        }
    }

    /**
     * onConnect 事件回调
     * 当客户端连接上gateway进程时(TCP三次握手完毕时)触发
     *
     * @access public
     * @param int $client_id
     * @return void
     */
    public static function onConnect($client_id)
    {
//        Gateway::sendToClient($client_id, json_encode(array(
//            'type'      => 'init',
//            'client_id' => $client_id,
//            'timeStemp' => time(),
//        )));
    }

    /**
     * onWebSocketConnect 事件回调
     * 当客户端连接上gateway完成websocket握手时触发
     *
     * @param integer $client_id 断开连接的客户端client_id
     * @param mixed $data
     * @return void
     */
    public static function onWebSocketConnect($client_id, $data)
    {
        var_export($data);
    }

    /**
     * onMessage 事件回调
     * 当客户端发来数据(Gateway进程收到数据)后触发
     *
     * @access public
     * @param int $client_id
     * @param mixed $data
     * @return void
     */
    public static function onMessage($client_id, $data)
    {
        $data = json_decode($data, true);
        if (!empty($data['member_id'])) {
            $member_id = $data['member_id'];
            $member = Cache::store('redis')->get('memberInfo' . $member_id);
            if (!empty($member)) $member = json_decode($member, true);
            if (empty($member)) {
                $member = Events::memberInfo($member_id);
                if (!empty($member)) {
                    $data['userInfo'] = $member;
                    Cache::store('redis')->set('memberInfo' . $member_id, json_encode($member), 3600);
                }
            }
        }

        $room_id = $data['room_id'] ?? '';

        // 根据类型执行不同的业务
        switch ($data['type']) {
            // 客户端回应服务端的心跳
            case 'ping':
                break;
            // 客户端登录 message格式: {type:login, name:xx, room_id:1} ，添加到客户端，广播给所有客户端xx进入聊天室
            case Enum::CHAT_LOGIN:
                Events::sendSystemMessage($client_id);
                if (!empty($member) && !empty($member_id)) {
                    Gateway::bindUid($client_id, $member['member_id']);
                    $message['member_type'] = 'member';
                    $message['member_id'] = $member['member_id'];
                    $message['nickname'] = $member['nickname'];
                    $message['avatar'] = $member['avatar'];
                } else if (!empty($member_id) && empty($member)) { // 如果传了member_id但查不到member，1.可能是数据库链接问题 2.可能是是没有此用户(一般不可能)
                    $mess['content'] = "没有查到member数据";
                    $mess['member_type'] = "no_member";
                    $mess['type'] = "2010";
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                } else {
                    $message['nickname'] = '游客_' . Events::checkNo();
                    $message['member_type'] = 'visitor';
                    Cache::store('redis')->set('visitorMember' . $client_id, $message['nickname']);
                }

                $message['content'] = $data;
                $message['type'] = Enum::CHAT_LOGIN;

                if (!empty($room_id)) {
                    Gateway::joinGroup($client_id, $room_id);
                    Gateway::sendToGroup($room_id, json_encode($message));
                    unset($message);
                }
                break;
            case Enum::CHAT_SEND_MESSAGE:
                if (empty($member)) {
                    $mess['content'] = "请先登录";
                    $mess['member_type'] = "no_login";
                    $mess['type'] = "2010";
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                }

                $is_allow = Cache::store('redis')->get('allow_send' . $member['member_id']);
                if (!empty($is_allow)) {
                    $mess['content'] = "两秒内只能发一次信息";
                    $mess['member_type'] = "no_allow";
                    $mess['type'] = "2010";
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                }
                Cache::store('redis')->set('allow_send' . $member['member_id'], $member['member_id'], 2);

                // 判断用户是否被禁言
                $model = new MuteRoomModel();
                $isForbid = $model->getMute($member['member_id']);
                if ($isForbid['status'] == Enum::MUTE_STATUS_NORMAL) {
                    $mess['content'] = "用户已被禁言";
                    $mess['member_id'] = $member['member_id'];
                    $mess['nickname'] = $member['nickname'];
                    $mess['type'] = Enum::CHAT_MUTE_NOTICE;
                    Gateway::sendToClient($client_id, json_encode($mess));
                    break;
                }

                $msg = $data['msg'] ?? '';
                // TODO 要设置过期时间
                $msgCount = (Cache::store('redis')->hLen("chatroom:history:" . $room_id)) + 1;
                Cache::store('redis')->hSet("chatroomHistory:" . $room_id, $msgCount, $member['member_id'] . ":" . $msg);

                $data['end_time'] = date('Y-m-d H:i:s', time());
                $send_data['content'] = $data;
                $send_data['member_id'] = $member['member_id'];
                $send_data['level'] = $member['level'];
                $send_data['nickname'] = $member['nickname'];
                $send_data['avatar'] = $member['avatar'];
                $send_data['type'] = Enum::CHAT_SEND_MESSAGE;
                $send_data['member_type'] = 'member';
                $send_data['msg_count'] = $msgCount;

                if (!empty($room_id)) Gateway::sendToGroup($room_id, json_encode($send_data));
                unset($send_data);
                break;
            case '4000':
                //进球事件
                Gateway::joinGroup($client_id, 'match4000');
                break;
            case '5011':
                //重启系统消息任务列表
//                Events::systemMessage();
                break;
            default :
                return;
        }
    }

    /**
     * onClose 事件回调 当用户断开连接时触发的方法
     *
     * @param integer $client_id 断开连接的客户端client_id
     * @return void
     */
    public static function onClose($client_id)
    {
        Cache::store('redis')->delete('visitorMember' . $client_id);
//        GateWay::sendToAll("client[$client_id] logout\n");
        Cache::store('redis')->delete('visitorMember' . $client_id);
    }

    /**
     * onWorkerStop 事件回调
     * 当businessWorker进程退出时触发。每个进程生命周期内都只会触发一次。
     *
     * @param \Workerman\Worker $businessWorker
     * @return void
     */
    public static function onWorkerStop(Worker $businessWorker)
    {
//        echo "WorkerStop\n";
    }


    public static function memberInfo($member_id)
    {
        $member = new MemberModel();
        $member_info = $member->getMember($member_id);

        if (!empty($member_info)) {
            return $member_info;
        } else {
            return null;
        }
    }

    public static function checkNo()
    {
        $room_id = mt_rand(500000, 799999);
        $num = Cache::store('redis')->SCARD('visitor_list');
        if ($num > 299999) Cache::store('redis')->delete('visitor_list');
        $is = Cache::store('redis')->SISMEMBER('visitor_list', $room_id);
        if (!$is) {
            Cache::store('redis')->SADD('visitor_list', $room_id);
            return $room_id;
        }
        return Events::checkNo();
    }

    public static function checkNoRobot()
    {
        $room_id = mt_rand(800000, 999999);
        $num = Cache::store('redis')->SCARD('robot_visitor_list');
        if ($num > 199999) Cache::store('redis')->delete('robot_visitor_list');
        $is = Cache::store('redis')->SISMEMBER('robot_visitor_list', $room_id);
        if (!$is) {
            Cache::store('redis')->SADD('robot_visitor_list', $room_id);
            return $room_id;
        }
        return Events::checkNo();
    }

    public static function sendSystemMessage($client_id)
    {

        $system_data = Cache::store('redis')->get('sendSystemMessage');
        if (!empty($system_data)) $system_lists = json_decode($system_data, true);
        if (empty($system_lists)) {
            $system_message = new SystemMessageModel();
            $system_lists = $system_message->lists();
            Cache::store('redis')->set('sendSystemMessage', json_encode($system_lists), 86400);
        }

        if (!empty($system_lists[0])) {
            $data['type'] = '1120';
            $data['content']['msg'] = $system_lists[0]['content'];
            Gateway::sendToClient($client_id, json_encode($data));
        }
    }

    public static function updateToday()
    {
        $time_task_system = 120;
        Timer::add($time_task_system, function () {
            $url = Config::get('match.url');
            $api = '/football/today.aspx';
            $key = Config::get('match.key');
            $api_url = $url . $api . '?key=' . $key;
            $data = Events::curlGetData($api_url);
            $data = json_decode($data, true);
            if (empty($data['matchList'])) return '数据为空';
            $scheduleModel = new ScheduleMatchModel();
            $res = $scheduleModel->addSchedule($data);
            return json($res);
        });
    }


    public static function curlGetData($url)
    {

        $header = array(
            'Accept: application/json',
        );
        $curl = curl_init();
        //设置抓取的url
        curl_setopt($curl, CURLOPT_URL, $url);
        //设置头文件的信息作为数据流输出
        curl_setopt($curl, CURLOPT_HEADER, 0);
        // 超时设置,以秒为单位
        curl_setopt($curl, CURLOPT_TIMEOUT, 50000);
        // 超时设置，以毫秒为单位
        curl_setopt($curl, CURLOPT_TIMEOUT_MS, 50000);
        // 设置请求头
        curl_setopt($curl, CURLOPT_HTTPHEADER, $header);
        //设置获取的信息以文件流的形式返回，而不是直接输出。
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
        //执行命令
        $data = curl_exec($curl);
        // 显示错误信息
        if (curl_error($curl)) {
            return curl_error($curl);
        } else {
            // 打印返回的内容
            curl_close($curl);
            return $data;
        }
    }

    public static function systemMessage()
    {

        $time_task_system = 60;
        Timer::add($time_task_system, function () {
            $system_lists = Cache::store('redis')->get('system_lists');
            if (empty($system_lists)) {
                $system_message = new SystemMessageModel();
                $system_lists = $system_message->lists();
                Cache::store('redis')->set('system_lists', json_encode($system_lists));
                if (!empty($system_lists[0])) {
                    foreach ($system_lists as $k => $v) {
                        if (!empty($v['cycle']) && $v['status'] == 2) {
                            $is_run = Cache::store('redis')->get('system_lists_timer_id' . $v['id']);
                            if (!empty($is_run)) Timer::del($is_run);

                            $v['cycle'] = intval($v['cycle']);
                            $time_interval = $v['cycle'];
                            $timer_id = Timer::add($time_interval, function () use ($k, $v) {
                                $data['type'] = '1120';
                                $data['content']['msg'] = $v['content'];
                                Gateway::sendToAll(json_encode($data));
                                unset($data);
                            });
                            unset($content);
                            Cache::store('redis')->set('system_lists_timer_id' . $v['id'], $timer_id);
                        }
                    }
                }
            }
        });
    }
}


```

