# äºŒ. Netty å…¥é—¨



## 1. æ¦‚è¿°



### 1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ

```
Netty is an asynchronous event-driven network application framework
for rapid development of maintainable high performance protocol servers & clients.Copy to clipboardErrorCopied
```

Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯



### 1.2 Netty çš„ä½œè€…

Trustin Lee éŸ©å›½äºº

ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…



### 1.3 Netty çš„åœ°ä½

Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½

ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼

- Cassandra - nosql æ•°æ®åº“
- Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶
- Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶
- RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—
- ElasticSearch - æœç´¢å¼•æ“
- gRPC - rpc æ¡†æ¶
- Dubbo - rpc æ¡†æ¶
- Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯
- Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶6+

### 1.4 Netty çš„ä¼˜åŠ¿

- Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š
  - éœ€è¦è‡ªå·±æ„å»ºåè®®
  - è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…
  - epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%
  - å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal => ThreadLocalï¼ŒByteBuf => ByteBuffer
- Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶
  - Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€
  - ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬
    - 2.x 2004
    - 3.x 2008
    - 4.x 2013
    - 5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰



## [2. Hello World](https://bright-boy.gitee.io/technical-notes/#/ç½‘ç»œç¼–ç¨‹/netty?id=_2-hello-world)



### 2.1 ç›®æ ‡

å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯

- å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world
- æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›

åŠ å…¥ä¾èµ–

```xml
<dependency>
    <groupId>io.netty</groupId>
    <artifactId>netty-all</artifactId>
    <version>4.1.39.Final</version>
</dependency>
```

### 2.2 æœåŠ¡å™¨ç«¯

```java
package netty.c1;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringDecoder;

public class HelloServer {

    public static void main(String[] args) {
        // 1. å¯åŠ¨å™¨ è´Ÿè´£ç»„è£… netty ç»„ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨
        new ServerBootstrap()
                // 2. åˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º çº¿ç¨‹æ±  + Selector
                .group(new NioEventLoopGroup())
                // 3. é€‰æ‹© æœåŠ¡å™¨çš„ ServerSocketChannel å®ç°
                .channel(NioServerSocketChannel.class) // OIO
                // 4. boss è´Ÿè´£å¤„ç†è¿æ¥ worker(child) è´Ÿè´£å¤„ç†è¯»å†™ è¯¥æ–¹æ³•å†³å®šäº† child èƒ½æ‰§è¡Œå“ªäº›æ“ä½œï¼ˆhandlerï¼‰
                .childHandler(
                        // 5. channel ä»£è¡¨å’Œå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®æ•°æ®è¯»å†™çš„é€šé“ Initializer åˆå§‹åŒ–ï¼Œè´Ÿè´£æ·»åŠ åˆ«çš„ handler
                        new ChannelInitializer<NioSocketChannel>() {
                            @Override
                            protected void initChannel(NioSocketChannel ch) throws Exception {
                                // 6. æ·»åŠ å…·ä½“ handler
                                ch.pipeline().addLast(new StringDecoder()); // å°† ByteBuf è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                                ch.pipeline().addLast(new ChannelInboundHandlerAdapter() { // è‡ªå®šä¹‰ handler
                                    @Override
                                    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
                                        System.out.println(msg);
                                    }
                                });
                            }
                        }
                )
                // 6. ç»‘å®šç›‘å¬ç«¯å£
                .bind(8880);
    }
}
```

### 2.3 å®¢æˆ·ç«¯

```java
package netty.c1;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringEncoder;

import java.net.InetSocketAddress;

public class HelloClient {

    public static void main(String[] args) throws InterruptedException {
        // 1. å¯åŠ¨ç±»
        new Bootstrap()
                // 2. æ·»åŠ  EventLoop
                .group(new NioEventLoopGroup())
                // 3. é€‰æ‹©å®¢æˆ·ç«¯ channel å®ç°
                .channel(NioSocketChannel.class)
                // 4. æ·»åŠ å¤„ç†å™¨
                .handler(new ChannelInitializer<NioSocketChannel>() {
                    @Override // åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨
                    protected void initChannel(NioSocketChannel ch) throws Exception {
                        ch.pipeline().addLast(new StringEncoder());
                    }
                })
                // 5. è¿æ¥åˆ°æœåŠ¡å™¨
                .connect(new InetSocketAddress("localhost", 8880))
                .sync()
                .channel()
                // 6. å‘æœåŠ¡å™¨å‘é€æ•°æ®
                .writeAndFlush("hello, world");
    }
}
```

### 2.4 æµç¨‹æ¢³ç†

![img](./imgs/2.4 æµç¨‹æ¢³ç†.png)



### ğŸ’¡ æç¤º

> ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ
>
> - æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“
> - æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf
> - æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº
>   - å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆ...ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰
>   - handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»
> - æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº
>   - å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰
>   - å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡
>   - å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº





## 3. ç»„ä»¶



### 3.1 EventLoop

äº‹ä»¶å¾ªç¯å¯¹è±¡

EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ªSelectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ ioäº‹ä»¶ã€‚

å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚

- ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•

- å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ
  - æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop
  
  - æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup
  
    

äº‹ä»¶å¾ªç¯ç»„

EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰

- ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup
  - å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›
  
  - å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop
  
    

ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š

