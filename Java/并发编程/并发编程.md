# 并发编程

## 0. 配置

### 日志

日志logback.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%date{HH:mm:ss} [%t] %logger - %m%n </pattern>
        </encoder>
    </appender>

    <logger name="c" level="DEBUG" additivity="false">
        <appender-ref ref="STDOUT" />
    </logger>

    <root level="ERROR">
        <appender-ref ref="STDOUT"/>
    </root>

</configuration>
```

日志使用

```java
@Slf4j(topic = "c.TestTread")  
public class TestThread {
	... 
}
```



## 1. 概览



### 1.1 这门课讲什么

这门课的 `并发` 一词覆盖了在Java平台上的

* 进程
* 线程
* 并发
* 并行

以及Java并发工具、并发问题以及解决方案，同时我也会讲解一些其它领域的并发



### 1.2 为什么学这门课

##### 我工作中用不到并发啊？   

* 如果并不满足于做应用层（增删改查），想往更高层面发展，那这门课很有价值。

* 如平时用的Tomcat服务器、RPC框架(如Dubbo)、消息中间件、消息队列、RocketMQ、RabbitMQ等等这些应用程序服务器，这些框架，底层肯定涉及到多线程，和并发问题打交道 

  

### 1.3 课程特色

本门课程以并发、并行为主线，穿插讲解

* 应用 - 结合实际
* 原理 - 了然于胸
* 模式 - 正确姿势

![img](http://blog.piplong.cn/wp-content/uploads/2021/09/0-00000005.png)

### 1.4 预备知识

* 希望你不是初学者
* 线程安全问题，需要你接触过 Java Web 开发、Jdbc 开发、Web 服务器、分布式框架时才会遇到
* 基于 JDK 8，最好对函数式编程、lambda 有一定了解
* 采用了 slf4j 打印日志
* 采用了 lombok 简化 java bean 编写
* 给每个线程好名字



pom.xml 依赖如下





## 2. 进程与线程



### 本章内容

* 进程和线程的概念
* 并行和并发的概念
* 线程基本应用



### 2.1 进程与线程



#### 进程

* 程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至CPU，数据加载至内存。在指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理 IO 的
* 当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。
* 进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器等），也有的程序只能启动一个实例进程（例如网易云音乐、360安全卫士等）



#### 线程

* 一个进程之内可以分为一道多个线程。
* 一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给CPU执行
* Java 中，线程作为最小调度单位，进程作为资源分配的最小单位，在 windows 中进程是不活动的，只是作为线程的容器



#### 二者对比

* 进程基本上互相独立的，而线程存在于进程内，是进程的一个子集
* 进程拥有共享的资源，如内存空间等，供其内部的线程共享
* 进程间通信较为复杂
  * 同一台计算机的进程通信称为 IPC （Inter-process communication）
  * 不同计算机之间的进程通信，需要通过网络，并遵守共同的协议，例如 HTTP
* 线程通信相对简单，因为它们共享进程内的内存，一个例子是多个线程可以访问同一个共享变量
* 线程更轻量，线程上下文切换成本一般要比进程上下文切换低



### 2.2 进程与线程



#### 并发

在单核 cpu 下，线程实际还是串行执行的。操作系统中有一个组件叫做任务调度器，将 cpu 的时间片（windows 下时间片最小约为 15 毫秒）分给不同的程序使用，只是由于 cpu 在线程间（时间片很短）的切换非常快，人类感觉是同时运行的。一般会将这种线程轮流使用 CPU 的做法称为并发（concurrent）



#### 并行

多核 cpu 下，每个核（core）都可以调度运行线程，这时候线程可以是并行的，不同的线程同时使用不同的 cpu 在执行。



#### 二者对比

引用 Rob Pike（golang语言创造者） 的一段描述：

* 并发（concurrent）是同一时间应对（dealing with）多件事情的能力，
* 并行（parallel）是同一时间动手做（doing）多件事件的能力

例子：

* 家庭主妇做饭、打扫卫生、给孩子喂奶，她一个人轮流交替做这么多事，这时就是并发
* 雇了3个保姆，一个专做饭、一个专门打扫卫生、一个专喂奶，互不干扰，这时是并行
* 家庭主妇雇了个保姆，她们一起做这些事，这时既有并发，也有并行（这时会产生竞争，例如锅只有一口，一个人用锅时，另一个人就得等待）

大多数情况程序是既有并发，也有并行



#### 应用之异步调用

##### 同步和异步的概念

以调用方的角度讲，如果

* 需要等待结果返回才能继续运行的话就是同步
* 不需要等待就是异步

##### 1) 设计

多线程可以使方法的执行变成异步的，比如说读取磁盘文件时，假设读取操作花费了5秒，如果没有线程的调度机制，那么cpu只能等5秒，啥也不能做。

##### 2) 结论

* 比如在项目中，视频文件需要转换格式等操作比较费时，这时开一个新线程处理视频转换，避免阻塞主线程
* tomcat 的异步 servelt 也是类似的目的，让用户线程处理耗时较长的操作，避免阻塞 tomcat 的工作线程
* ui 程序中，开线程进行其它操作，避免阻塞 ui 线程





## 3. Java 线程

### 3.1 创建和运行线程



#### 方法一 直接使用 Thread

```java
@Slf4j(topic = "c.TestTread")
public class TestThread {
    public static void main(String[] args) {
        // 构造方法的参数是给线程指定名字，，推荐给线程起个名字
        Thread t1 = new Thread("t1") {
            @Override
            public void run() {  // run 方法内实现了要执行的任务
                log.debug("hello");
            }
        };
        t1.start();
        log.debug("running");
    }
}
```



