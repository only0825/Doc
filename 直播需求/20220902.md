

准备做

\1. 聊天室 删除单条消息

\2. 弹幕实现

\5. 赛事推荐 拿的时间也  优先级：有无主播、 开播时间

\6. 机器人 进聊天室 （为了炒直播间）



敏感字未屏蔽 （感觉可以用es做，但暂时不做）



完成：

##### 这里是1级联赛

![image-20220902141440343](/Users/wh37/Library/Application Support/typora-user-images/image-20220902141440343.png)

##### 联赛查询结果改为1、2级（之前为1级）

![image-20220902132614548](/Users/wh37/Library/Application Support/typora-user-images/image-20220902132614548.png)

##### 全部直播和热门直播 看看排序是按什么的

热门直播和全部直播调用的一个接偶/api/live/hotRoom

排序规则：sort从大到小、热度从大到小

sort的优先级高于热度

查询条件：当后台直播管理的推荐开启时 





##### 赛程和未来赛程接口调整 

这两个接口一样 

/api/scheduleMatch/lists

/api/scheduleMatch/matchLists



##### 赛程接口查询时间区间：改为早上的08:00:00点到第二日早上的07:59:59





```
<?php
declare (strict_types = 1);

namespace app\api\controller;

use app\api\model\AnchorModel;
use app\api\model\CollectModel;
use app\api\model\LeaguesModel;
use app\api\model\LineupModel;
use app\api\model\LiveRoomModel;
use app\api\model\PreordainModel;
use app\common\controller\Common;
use app\api\model\ScheduleMatchModel;
use think\facade\Cache;
use think\facade\Config;
use think\facade\Db;
use think\facade\Log;
use hg\apidoc\annotation as Apidoc;

/**
 * @Apidoc\Title("赛程管理")
 */
class ScheduleMatch extends Common
{
    public $schedule_match;
    public $schedule;
    public $lineup;
    public $collect;
    public $leagues;
    public $member_id;
    public $error_token;

    public $event = ["先开球","第一个角球","第一张黄牌","射门次数","射正次数","犯规次数","角球次数","角球次数(加时)","任意球次数","越位次数","乌龙球数","黄牌数","黄牌数(加时)","红牌数","控球率","头球","救球","守门员出击","丟球","成功抢断","阻截","长传","短传","助攻","成功传中","第一个换人","最后换人","第一个越位","最后越位","换人数","最后角球","最后黄牌","换人数(加时)","越位次数(加时)","射门不中","中柱","头球成功次数","射门被挡","铲球","过人次数","界外球","传球次数","传球成功率","进攻次数","危险进攻次数","半场角球","半场控球"];
    public function initialize()
    {
        parent::initialize();
        $this->schedule_match = new ScheduleMatchModel();
        $this->lineup = new LineupModel();
        $this->collect = new CollectModel();
        $this->leagues = new LeaguesModel();
        $params = $this->request->header();
        if (!empty($params['authorization'])) {
            $member = $this->checkToken();
            if (!empty($member['code'])) {
                $this->error_token = $member;
            }else{
                if (!empty($member['member_id'])) $this->member_id = $member['member_id'];
            }
        }
    }

    /**
     * @Apidoc\Title("三级赛事赛程")
     * @Apidoc\Desc("三级赛事赛程")
     * @Apidoc\Method("POST")
     * @Apidoc\Author("Mata")
     * @Apidoc\Tag("赛事管理接口")
     * @Apidoc\Param("pageNum", type="int",require=false,default="1", desc="第几页")
     * @Apidoc\Param("pageSize", type="int",require=false,default="10",desc="每页显示多少条")
     * @Apidoc\Param("day", type="int",require=false,desc="赛程时间")
     * @Apidoc\Param("leagueId", type="int",require=false,desc="联赛id")
     * @Apidoc\Param("playing", type="string",require=false,desc="已结束：3000 进行中：2000 赛程：1000")
     * @Apidoc\Param("leagueType", type="int",require=false,desc="联赛类型 1足球 2篮球 3电竞 4其他")
     * @Apidoc\Returned("anchor_list",type="array",desc="主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned("scheduled_anchor",type="array",desc="预约该赛事的主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned ("appointment",type="string",desc="是否已预约 1已预约 2未预约"),
     * @Apidoc\Returned(type="array",ref="app\api\model\ScheduleMatchModel\lists")
     */
    public function otherMatch(){
        $member_id = '';
        $params = $this->request->header();
        if (!empty($params['authorization'])) $member = $this->checkToken();
        if (!empty($member['member_id'])) $member_id = $member['member_id'];

        $res = $this->schedule_match->otherLists();
        if (!empty($res['data'])) {
            $liveRoomModel = new LiveRoomModel();
            $anchor_list = $liveRoomModel->alias("lr")->join("anchor ar","ar.member_id = lr.member_id")->where(['lr.status'=>1,'lr.live_status'=>2])->field(['lr.room_id','lr.img','lr.username','lr.is_position','ar.heat as heat_num','lr.live_status','lr.nick','lr.match_id'])->order('ar.heat','desc')->select()->all();

            $preordainModel = new PreordainModel();
            $pn_where['pn.preordain_status'] = 1;
            $pn_where['ar.status'] = 1;
            $pn_where['pn.state'] = 0;
            $scheduled = $preordainModel->alias('pn')->join('anchor ar','pn.member_id = ar.member_id')->where($pn_where)->field(['pn.id','pn.matchId','pn.member_id as room_id','pn.anchor_name','ar.logo as img'])->select()->all();
            if (!empty($scheduled)) {
                $scheduled_anchor = [];
                foreach ($scheduled as $pk => $pv) {
                    if (!empty($pv['matchId'])) $scheduled_anchor[$pv['matchId']][] = $pv;
                }
            }

            foreach ($res['data'] as $k => $v ){
                $res['data'][$k]['anchor_list'] = [];
                $res['data'][$k]['anchor_number'] = 0;
                $anchor_number = 0;
                $room_list = [];
                $res['data'][$k]['anchor_list'] = $room_list;
                $res['data'][$k]['anchor_number'] = $anchor_number;
                if (!empty($anchor_list)) {
                    foreach ($anchor_list as $kk => $vv ){
                        if ($v['matchId'] == $vv['match_id']){
                            $anchor_number += 1;
                            $room_list[] = $vv;
                        }
                    }
                    if (!empty($room_list)) {
                        $res['data'][$k]['anchor_list'] = $room_list;
                        $res['data'][$k]['anchor_number'] = $anchor_number;
                    }
                }
                $res['data'][$k]['scheduled_anchor'] = null;
                if (!empty($scheduled_anchor[$v['matchId']])) $res['data'][$k]['scheduled_anchor'] = $scheduled_anchor[$v['matchId']];


                if (!empty($v['matchStartTime'])) $res['data'][$k]['matchTime'] = date('Y-m-d H:i',$v['matchStartTime']);
                if (!empty($member_id)){
                    $res['data'][$k]['appointment'] = '2';
                    $is_appointment = Db::table('hn_member_attention')->where(['status'=>2,'match_id'=>$v['matchId'],'member_id'=>$member_id])->value('id');
                    if ($is_appointment) $res['data'][$k]['appointment'] = '1';
                }else{
                    $res['data'][$k]['appointment'] = '2';
                }


                if ($v['state'] == 1 && !empty($v['startTime'])) {
                    $timing = bcsub(strval(time()), strval(strtotime($v['startTime'])));
                    $res['data'][$k]['timing'] = bcdiv($timing, '60');
                }
                if (($v['state'] == 3 || $v['state'] == 4 || $v['state'] == 5) && !empty($v['startTime'])) {
                    $timing = bcsub(strval(time()), strval(strtotime($v['startTime'])));
                    $timing = bcadd($timing, '2700');
                    $res['data'][$k]['timing'] = bcdiv($timing, '60');
                }

                if (!empty($res['data'][$k]['timing']) && $res['data'][$k]['timing'] > 90) $res['data'][$k]['timing'] = '90+';
                if ($v['state'] == 2) $res['data'][$k]['timing'] = '中';
                if ($v['state'] == 4) $res['data'][$k]['timing'] = '加';
                if ($v['state'] == 5) $res['data'][$k]['timing'] = '点';

                if (!empty($v['startTime'])) $res['data'][$k]['startTime'] = date('Y/m/d H:i', strtotime($v['startTime']));
                if (!empty($v['matchTime'])) $res['data'][$k]['matchTime'] = date('Y/m/d H:i', $v['matchStartTime']);
            }
            unset($anchor_list);
        }

        return $this->ReturnSuccess($res);

    }

    /**
     * @Apidoc\Title("赛程")
     * @Apidoc\Desc("赛程")
     * @Apidoc\Method("POST")
     * @Apidoc\Author("Mata")
     * @Apidoc\Tag("赛事管理接口")
     * @Apidoc\Param("pageNum", type="int",require=false,default="1", desc="第几页")
     * @Apidoc\Param("pageSize", type="int",require=false,default="10",desc="每页显示多少条")
     * @Apidoc\Param("day", type="int",require=false,desc="赛程时间")
     * @Apidoc\Param("hierarchy", type="string",require=false,desc="联赛级别，多个联赛用英文逗号分割，如:1,2 不传默认为1,2级联赛")
     * @Apidoc\Param("leagueId", type="int",require=false,desc="联赛id，当值为100000时，结果为3级联赛")
     * @Apidoc\Param("playing", type="string",require=false,desc="已结束：3000 进行中：2000 赛程：1000")
     * @Apidoc\Param("leagueType", type="int",require=false,desc="联赛类型 1足球 2篮球 3电竞 4其他")
     * @Apidoc\Returned("anchor_list",type="array",desc="主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned("scheduled_anchor",type="array",desc="预约该赛事的主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned ("appointment",type="string",desc="是否已预约 1已预约 2未预约"),
     * @Apidoc\Returned(type="array",ref="app\api\model\ScheduleMatchModel\lists")
     */
    public function lists()
    {
        $header = $this->request->header();
        $params = request()->post();

        // 拿到当前用户的member_id
        if (!empty($header['authorization'])) $member = $this->checkToken();
        $member_id = !empty($member['member_id']) ? $member['member_id']:'';

        $whereBtw = $this->schedule_match->startEndTime($params['day']);

        // 根据传的条件查询赛程
        $data['whereBtw'] = $whereBtw;
        $data['day'] = !empty($params['day']) ? $params['day'] : '';
        $data['pageSize'] = $params['pageSize'] ?? 100;
        $data['pageNum'] = $params['pageNum'] ?? 1;
        $data['leagueId'] = !empty($params['leagueId']) ? $params['leagueId'] : '';
        $data['leagueType'] = !empty($params['leagueType']) ? $params['leagueType'] : '';
        $data['playing'] = !empty($params['playing']) ? $params['playing'] : '';

        $hierarchy = !empty($params['hierarchy']) ? $params['hierarchy'] : "1,2";
        $data['hierarchy'] = trim(str_replace("，", ",", $hierarchy));

        if (!empty($data['leagueId']) && $data['leagueId'] == 100000) {
            $data['hierarchy'] = 3;
            $data['leagueId'] = '';
        }

        $res = $this->schedule_match->lists($data);

        if (!empty($res['data'])) {

            $anchorModel = new AnchorModel();
            // 查询正在直播中的主播
            $anchorList = $anchorModel->anchorLiveList();
            // 查询有预约的主播
            $scheduled = $anchorModel->anchorPreordain();

            // 如果主播有预约赛事
            if (!empty($scheduled)) {
                $scheduledAnchor = [];
                foreach ($scheduled as $pk => $pv) {
                    if (!empty($pv['matchId'])) {
                        $scheduledAnchor[$pv['matchId']][] = $pv;
                    }
                }
            }

            foreach ($res['data'] as $k => $v ){
                $res['data'][$k]['anchor_list'] = [];
                $res['data'][$k]['anchor_number'] = 0;

                // 如果有正在直播的主播
                if (!empty($anchorList)) {
                    foreach ($anchorList as $vv ){
                        if ($v['matchId'] == $vv['match_id']){
                            $anchorNumber += 1;
                            $roomList[] = $vv;
                        }
                    }
                    if (!empty($roomList)) {
                        $res['data'][$k]['anchor_number'] = $anchorNumber;
                        $res['data'][$k]['anchor_list'] = $roomList;
                    }
                }

                // 有预约的主播
                $res['data'][$k]['scheduled_anchor'] = null;
                if (!empty($scheduledAnchor[$v['matchId']])) {
                    $res['data'][$k]['scheduled_anchor'] = $scheduledAnchor[$v['matchId']];
                }

                if (!empty($v['matchStartTime'])) {
                    $res['data'][$k]['matchTime'] = date('Y-m-d H:i',$v['matchStartTime']);
                }

                // 当前用户是否关注该赛事 appointment 1关注 2未关注
                if (!empty($member_id)){
                    $res['data'][$k]['appointment'] = '2';
                    $is_appointment = Db::table('hn_member_attention')
                        ->where([
                            'status' => 2,
                            'match_id' => $v['matchId'],
                            'member_id' => $member_id
                        ])
                        ->value('id');
                    if ($is_appointment) $res['data'][$k]['appointment'] = '1';
                }else{
                    $res['data'][$k]['appointment'] = '2';
                }

                // 当playing不为赛程时
                if ($data['playing'] != 1000) {
                    // 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
                    if ($v['state'] == 1 && !empty($v['startTime'])) {
                        $timing = bcsub(strval(time()), strval(strtotime($v['startTime'])));
                        $res['data'][$k]['timing'] = bcdiv($timing, '60');
                    }
                    if (($v['state'] == 3 || $v['state'] == 4 || $v['state'] == 5) && !empty($v['startTime'])) {
                        $timing = bcsub(strval(time()), strval(strtotime($v['startTime'])));
                        $timing = bcadd($timing, '2700');
                        $res['data'][$k]['timing'] = bcdiv($timing, '60');
                    }

                    if (!empty($res['data'][$k]['timing']) && $res['data'][$k]['timing'] > 90) {
                        $res['data'][$k]['timing'] = '90+';
                    }
                    if ($v['state'] == 2) $res['data'][$k]['timing'] = '中';
                    if ($v['state'] == 4) $res['data'][$k]['timing'] = '加';
                    if ($v['state'] == 5) $res['data'][$k]['timing'] = '点';

                    if (!empty($v['startTime'])) {
                        $res['data'][$k]['startTime'] = date('Y/m/d H:i', strtotime($v['startTime']));
                    }
                    if (!empty($v['matchTime'])) {
                        $res['data'][$k]['matchTime'] = date('Y/m/d H:i', $v['matchStartTime']);
                    }
                }
            }
            unset($anchorList);
            unset($scheduled);
        }
        return $this->ReturnSuccess($res);
    }

    /**
     * @Apidoc\Title("未来赛程")
     * @Apidoc\Desc("未来赛程")
     * @Apidoc\Method("POST")
     * @Apidoc\Author("Mata")
     * @Apidoc\Tag("赛事管理接口")
     * @Apidoc\Param("pageNum", type="int",require=false,default="1", desc="第几页")
     * @Apidoc\Param("pageSize", type="int",require=false,default="10",desc="每页显示多少条")
     * @Apidoc\Param("day", type="int",require=false,desc="赛程时间")
     * @Apidoc\Param("leagueId", type="int",require=false,desc="联赛id")
     * @Apidoc\Param("leagueType", type="int",require=false,desc="联赛类型 1足球 2篮球 3电竞 4其他")
     * @Apidoc\Returned("anchor_list",type="array",desc="主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned("scheduled_anchor",type="array",desc="预约该赛事的主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned ("appointment",type="string",desc="是否已预约 1已预约 2未预约"),
     * @Apidoc\Returned(type="array",ref="app\api\model\ScheduleMatchModel\lists")
     */
    public function matchLists(){
        $member_id = '';
        $params = $this->request->header();
        if (!empty($params['authorization'])) $member = $this->checkToken();
        if (!empty($member['member_id'])) $member_id = $member['member_id'];

        $res = $this->schedule_match->matchLists();
        if (!empty($res['data'])) {
            $liveRoomModel = new LiveRoomModel();
            $anchor_list = $liveRoomModel->alias("lr")->join("anchor ar","ar.member_id = lr.member_id")->where(['lr.status'=>1,'lr.live_status'=>2])->field(['lr.room_id','lr.img','lr.username','lr.is_position','ar.heat as heat_num','lr.live_status','lr.nick','lr.match_id'])->order('ar.heat','desc')->select()->all();

            $preordainModel = new PreordainModel();
            $pn_where['pn.preordain_status'] = 1;
            $pn_where['ar.status'] = 1;
            $pn_where['pn.state'] = 0;
            $scheduled = $preordainModel->alias('pn')->join('anchor ar','pn.member_id = ar.member_id')->where($pn_where)->field(['pn.id','pn.matchId','pn.member_id as room_id','pn.anchor_name','ar.logo as img'])->select()->all();
            if (!empty($scheduled)) {
                $scheduled_anchor = [];
                foreach ($scheduled as $pk => $pv) {
                    if (!empty($pv['matchId'])) $scheduled_anchor[$pv['matchId']][] = $pv;
                }
            }

            foreach ($res['data'] as $k => $v ){
                $res['data'][$k]['anchor_list'] = [];
                $res['data'][$k]['anchor_number'] = 0;
                $anchor_number = 0;
                $room_list = [];
                $res['data'][$k]['anchor_list'] = $room_list;
                $res['data'][$k]['anchor_number'] = $anchor_number;
                if (!empty($anchor_list)) {
                    foreach ($anchor_list as $kk => $vv ){
                        if ($v['matchId'] == $vv['match_id']){
                            $anchor_number += 1;
                            $room_list[] = $vv;
                        }
                    }
                    if (!empty($room_list)) {
                        $res['data'][$k]['anchor_list'] = $room_list;
                        $res['data'][$k]['anchor_number'] = $anchor_number;
                    }
                }
                $res['data'][$k]['scheduled_anchor'] = null;
                if (!empty($scheduled_anchor[$v['matchId']])) $res['data'][$k]['scheduled_anchor'] = $scheduled_anchor[$v['matchId']];


                if (!empty($v['matchStartTime'])) $res['data'][$k]['matchTime'] = date('Y-m-d H:i',$v['matchStartTime']);
                if (!empty($member_id)){
                    $res['data'][$k]['appointment'] = '2';
                    $is_appointment = Db::table('hn_member_attention')->where(['status'=>2,'match_id'=>$v['matchId'],'member_id'=>$member_id])->value('id');
                    if ($is_appointment) $res['data'][$k]['appointment'] = '1';
                }else{
                    $res['data'][$k]['appointment'] = '2';
                }
            }
            unset($anchor_list);
        }

        return $this->ReturnSuccess($res);

    }

    /**
     * @Apidoc\Title("联赛赛程")
     * @Apidoc\Desc("联赛赛程")
     * @Apidoc\Method("POST")
     * @Apidoc\Author("Mata")
     * @Apidoc\Tag("赛事管理接口")
     * @Apidoc\Param("leagueId", type="int",require=false,desc="联赛ID")
     * @Apidoc\Returned(type="array",ref="app\api\model\ScheduleMatchModel\getMatchByLeaguesId")
     */
    public function getSchedule(){
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->getMatchByLeaguesId();
        if (!empty($res['code'])) return $this->ReturnError($res);
        return $this->ReturnSuccess($res);

    }

    /**
     * @Apidoc\Title("联赛赛程 按日期")
     * @Apidoc\Desc("联赛赛程")
     * @Apidoc\Method("POST")
     * @Apidoc\Author("Mata")
     * @Apidoc\Tag("赛事管理接口")
     * @Apidoc\Param("leagueId", type="int",require=false,desc="联赛ID")
     * @Apidoc\Param("day", type="string",require=false,desc="日期 格式：2022-06-24")
     * @Apidoc\Returned(type="array",ref="app\api\model\ScheduleMatchModel\getMatchByDay")
     */
    public function getScheduleByDay(){
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->getMatchByDay();
        if (!empty($res['code'])) return $this->ReturnError($res);
        return $this->ReturnSuccess($res);

    }


    /**
     * @Apidoc\Title("热门赛程")
     * @Apidoc\Desc("热门赛程")
     * @Apidoc\Method("POST")
     * @Apidoc\Author("Mata")
     * @Apidoc\Tag("赛事管理接口")
     * @Apidoc\Param("day", type="int",require=false,desc="日期")
     * @Apidoc\Param("playing", type="string",require=false,desc="全部：3000 进行中：2000 赛程：1000")
     * @Apidoc\Returned("anchor_list",type="array",desc="主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned("scheduled_anchor",type="array",desc="预约该赛事的主播信息",
     * @Apidoc\Returned ("room_id",type="string",desc="直播间id"),
     * @Apidoc\Returned ("img",type="string",desc="主播头像"),
     * )
     * @Apidoc\Returned ("appointment",type="string",desc="是否已预约 1已预约 2未预约"),
     * @Apidoc\Returned(type="array",ref="app\api\model\ScheduleMatchModel\match")
     */
    public function hotMatch()
    {
        $header = $this->request->header();
        $params = request()->post();
        $scheduleModel = new ScheduleMatchModel();

        // 拿到当前用户的member_id
        if (!empty($header['authorization'])) $member = $this->checkToken();
        $member_id = !empty($member['member_id']) ? $member['member_id']:'';

        $data['playing'] = !empty($params['playing']) ? $params['playing']:'';
        $data['whereBtw'] = $this->schedule_match->startEndTime($params['day']);

        $res = $scheduleModel->match($data);

        $anchor_list = Db::table('hn_live_room')->where(['status'=>1,'live_status'=>2])
            ->field(['room_id','img','username','is_position','heat_num','live_status','nick','match_id'])
            ->order('heat_num','desc')
            ->select()->all();

        $preordainModel = new PreordainModel();
        $pn_where['pn.preordain_status'] = 1;
        $pn_where['ar.status'] = 1;
        $pn_where['pn.state'] = 0;
        $scheduled = $preordainModel->alias('pn')
            ->join('anchor ar','pn.member_id = ar.member_id')->where($pn_where)
            ->field(['pn.id','pn.matchId','pn.member_id as room_id','pn.anchor_name','ar.logo as img'])
            ->select()->all();

        if (!empty($scheduled)) {
            $scheduled_anchor = [];
            foreach ($scheduled as $pk => $pv) {
                if (!empty($pv['matchId'])) $scheduled_anchor[$pv['matchId']][] = $pv;
            }
        }

        if (!empty($res['list'][0])) {
            foreach ($res['list'] as $k => $v ){
                $res['list'][$k]['anchor_list'] = [];
                $res['list'][$k]['anchor_number'] = 0;
                $anchor_number = 0;
                $room_list = [];

                if (!empty($anchor_list)) {
                    foreach ($anchor_list as $kk => $vv ){
                        if ($v['matchId'] == $vv['match_id']){
                            $anchor_number += 1;
                            $room_list[] = $vv;
                        }
                    }
                }

                if (!empty($room_list)) {
                    $res['list'][$k]['anchor_list'] = $room_list;
                    $res['list'][$k]['anchor_number'] = $anchor_number;
                }

                unset($room_list);
                unset($anchor_number);
                $res['list'][$k]['scheduled_anchor'] = null;

                if (!empty($scheduled_anchor[$v['matchId']])) $res['list'][$k]['scheduled_anchor'] = $scheduled_anchor[$v['matchId']];
                if (!empty($v['matchStartTime'])) $res['list'][$k]['matchTime']  = date('Y-m-d H:i',$v['matchStartTime']);
                if (!empty($member_id)){
                    $res['list'][$k]['appointment'] = '2';
                    $is_appointment = Db::table('hn_member_attention')
                        ->where(['status'=>2,'match_id'=>$v['matchId'],'member_id'=>$member_id])
                        ->value('id');
                    if ($is_appointment) $res['list'][$k]['appointment'] = '1';
                }
            }
        }
        return $this->ReturnSuccess($res);
    }
}
```





```
<?php

namespace app\api\model;

use app\common\controller\Enum;
use think\db\exception\DataNotFoundException;
use think\db\exception\DbException;
use think\db\exception\ModelNotFoundException;
use think\facade\Log;
use think\Model;
use hg\apidoc\annotation\Field;
use hg\apidoc\annotation\WithoutField;
use hg\apidoc\annotation\AddField;
use hg\apidoc\annotation\Param;

class ScheduleMatchModel extends Model
{
    // 设置当前模型对应的完整数据表名称
    protected $table = 'hn_schedule';
    protected $pageSize;
    protected $page;
    protected $startTime = " 08:00:00";
    protected $endTime = " 07:59:59";

    // 设置字段信息
    protected $schema = [
        "id"             => "int",
        "matchId"        => "int",
        "color"          => "string",
        "kind"           => "int",
        "leagueId"       => "int",
        "leagueEn"       => "string",
        "leagueEnShort"  => "string",
        "leagueChsShort" => "string",
        "leagueChtShort" => "string",
        "subLeagueId"    => "string",
        "subLeagueEn"    => "string",
        "subLeagueChs"   => "string",
        "subLeagueCht"   => "string",
        "matchTime"      => "string",
        "startTime"      => "string",
        "homeEn"         => "string",
        "homeChs"        => "string",
        "homeCht"        => "string",
        "awayEn"         => "string",
        "awayChs"        => "string",
        "awayCht"        => "string",
        "homeId"         => "int",
        "awayId"         => "int",
        "state"          => "int",
        "homeScore"      => "int",
        "awayScore"      => "int",
        "homeHalfScore"  => "int",
        "awayHalfScore"  => "int",
        "homeRed"        => "int",
        "awayRed"        => "int",
        "homeYellow"     => "int",
        "awayYellow"     => "int",
        "homeCorner"     => "int",
        "awayCorner"     => "int",
        "homeRankEn"     => "string",
        "homeRankCn"     => "string",
        "awayRankEn"     => "string",
        "awayRankCn"     => "string",
        "isNeutral"      => "string",
        "hasLineup"      => "string",
        "season"         => "string",
        "groupId"        => "string",
        "roundEn"        => "string",
        "roundCn"        => "string",
        "grouping"       => "string",
        "locationEn"     => "string",
        "locationCn"     => "string",
        "weatherEn"      => "string",
        "weatherCn"      => "string",
        "temp"           => "string",
        "explainEn"      => "string",
        "explainCn"      => "string",
        "extraExplain"   => "string",
        "isHidden"       => "string",
        "updateTime"     => "string",
        "matchStartTime" => "int",
    ];


    /**
     * @Field("matchId,homeChs,awayChs,leagueChsShort,matchTime,state")
     */
    public function getMatchByLeaguesId()
    {
        $params = request()->post();

        $whereBtw = $this->startEndTime($params['day']);

        if (!empty($params['leagueId']) && $params['leagueId'] != 300000) $league_id['leagueId'] = $params['leagueId'];
        if (!empty($params['type'])) $league_id['leagueType'] = $params['type'];
        $whereIn = "0,1,2,3,4,5";

        $scheduleModel = new ScheduleMatchModel();

        if (!empty($league_id)) {
            $match_info = $scheduleModel->where($league_id)->whereIn('state', $whereIn)->whereBetween('matchStartTime', $whereBtw)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        } else {
            $match_info = $scheduleModel->whereIn('state', $whereIn)->whereBetween('matchStartTime', $whereBtw)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        }

        return $match_info;
    }

    /**
     * @Field("matchId,homeChs,awayChs,leagueChsShort,matchTime,state")
     */
    public function getMatchByDay()
    {
        $params = request()->post();
        if (empty($params['day'])) return [];
        $start = $params['day'];
        $start = strtotime($start);
        $end = $start + 86399;
        $where_between = [$start, $end];
        if (!empty($params['leagueId']) && $params['leagueId'] != 300000) $league_id['leagueId'] = $params['leagueId'];
        if (!empty($params['type'])) $league_id['leagueType'] = $params['type'];
        $whereIn = "0,1,2,3,4,5";

        $scheduleModel = new ScheduleMatchModel();

        if (!empty($league_id)) {
            $match_info = $scheduleModel->where($league_id)->whereIn('state', $whereIn)->whereBetween('matchStartTime', $where_between)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        } else {
            $match_info = $scheduleModel->whereIn('state', $whereIn)->whereBetween('matchStartTime', $where_between)->field(['matchId', 'homeChs', 'awayChs', 'leagueChsShort', 'matchTime', 'state'])->order('matchStartTime', 'AEC')->select()->all();
        }

        return $match_info;
    }

    public function lists($data)
    {
        $this->pageSize = $data['pageSize'];
        $this->page = $data['pageNum'];
        $whereBtw = $data['whereBtw'];
        $whereIn = "0,1,2,3,4,5,-1"; // 比赛状态 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        $hierarchy = $data['hierarchy']; // 联赛级别
        $leagueId =  $data['leagueId'];
        $leagueType =  $data['leagueType'];
        $day =  $data['day'];

        // playing参数为比赛状态(schedule表中的state) 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        // -10:取消 -11:待定 -12:腰斩 -13:中断 -14:推迟
        if (!empty($data['playing'])) {
            if ($data['playing'] == '1000') $playing = '0'; $whereIn = "0"; // 赛程：1000
            if ($data['playing'] == '2000') $playing = "1,2,3,4,5";  //   进行中：2000
            if ($data['playing'] == '3000') $playing = '-1'; //  已结束：3000
        }

        if (!empty($leagueId)) $whereType['sc.leagueId'] = $leagueId;
        if (!empty($leagueType)) $whereType['sc.leagueType'] = $leagueType;

        $fields = ['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime',
            'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore',
            'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo',
            'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore',
            'sc.awayHalfScore', 'sc.startTime', 'le.hierarchy'];
        $order = ['sc.state' => "DESC", 'sc.matchStartTime' => "ASC"];

        try {
            // 指定联赛类型和ID
            if (!empty($whereType)) {
                // 当赛程状态playing为 进行中2000 和 已结束3000
                if (!empty($playing)) {
                    // 查询条件:赛程状态为进行中或已结束 指定赛程表的ID和类型 指定日期
                    $res = $this->scBtwSql($hierarchy, $playing, $whereType, $whereBtw, $fields, $order);
                }
                // playing=1000 查询赛程，带有指定日期day参数
                elseif (!empty($day)) {
                    // 查询条件:赛程状态为0未开 指定赛程表的ID和类型 指定日期
                    $res = $this->scBtwSql($hierarchy, $whereIn, $whereType, $whereBtw, $fields, $order);
                }
                // playing=1000 查询赛程 没有指定日期 从今天算
                else {
                    $startTime = "matchStartTime >= " . time();
                    // 查询条件:赛程状态为0未开 指定赛程表的ID和类型 没有指定日期从今天算
                    $res = $this->scSql($hierarchy, $whereIn, $whereType, $startTime, $fields, $order);
                }

                // 不指定联赛类型和ID 不传whereType
            } else {
                // 当赛程状态playing为 进行中2000 和 已结束3000
                if (!empty($playing)) {
                    // 查询条件:赛程状态为进行中或已结束 不指定赛程表的ID和类型 指定日期
                    $res = $this->scBtwSql($hierarchy, $playing, array(), $whereBtw, $fields, $order);
                }
                // playing=1000 查询赛程，带有指定日期day参数
                elseif (!empty($day)) {
                    // 查询条件:赛程状态为0未开 不指定赛程表的ID和类型 指定日期
                    $res = $this->scBtwSql($hierarchy, $whereIn, array(), $whereBtw, $fields, $order);
                }
                // playing=1000 查询赛程 没有指定日期 从今天算
                else {
                    $startTime = "matchStartTime >= " . time();
                    // 查询条件:赛程状态为0未开 不指定赛程表的ID和类型 没有指定日期从今天算
                    $res = $this->scSql($hierarchy, $whereIn, array(), $startTime, $fields, $order);
                }
            }

            if (!empty($res)) return $res->toArray();

            return $res;

        } catch (DbException $e) {
            return ['code' => Enum::MATCH_LIST_EXCEPTION, 'msg' => $e->getMessage()];
        }
    }

    /**
     * @param $hierarchy string 联赛级别 1 2 3
     * @param $whereIn string 赛程表的状态 进行中或已结束
     * @param $whereType array 指定赛程表的ID和类型
     * @param $startTime string  赛程开始时间
     * @param $fields array 查询的字段
     * @param $order array 排序
     * @return mixed
     */
    public function scSql(string $hierarchy, string $whereIn, array $whereType, string $startTime, array $fields, array $order)
    {
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->alias('sc')
            // team表的teamId(球队ID)关联sc表的homeId(主队ID)与awayId(客队ID)
            ->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')
            // leagues联赛表
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            // 赛程表的状态为进行中或已结束 -> le.hierarchy 联赛的赛事级别为 1、2 -> 指定赛程表的ID和类型
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->where($whereType)
            ->field($fields)->order($order)->where($startTime)
            ->paginate([
                'list_rows' => $this->pageSize,
                'page'      => $this->page,
            ]);

        return $res;
    }

    /**
     * @param $hierarchy string 联赛级别 1 2 3
     * @param $whereIn string 赛程表的状态 进行中或已结束
     * @param $whereType array 指定赛程表的ID和类型
     * @param $where array 赛程开始和结束时间
     * @param $fields array 查询的字段
     * @param $order array 排序
     * @return mixed
     */
    public function scBtwSql(string $hierarchy, string $whereIn, array $whereType, array $where, array $fields, array $order)
    {
        $scheduleModel = new ScheduleMatchModel();
        $res = $scheduleModel->alias('sc')
            // team表的teamId(球队ID)关联sc表的homeId(主队ID)与awayId(客队ID)
            ->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')
            // leagues联赛表
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            // 赛程表的状态为进行中或已结束 -> le.hierarchy 联赛的赛事级别为 1、2 -> 指定赛程表的ID和类型
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->where($whereType)
            // 赛程开始和结束时间
            ->whereBetween('sc.matchStartTime', $where)
            ->field($fields)->order($order)
            ->paginate([
                'list_rows' => $this->pageSize,
                'page'      => $this->page,
            ]);
//        echo $scheduleModel->getLastSql();exit;
        return $res;
    }

    public function matchLists($member_id = '')
    {
        $params = request()->post();
        $page_size = $params['pageSize'] ?? 100;
        $page = $params['pageNum'] ?? 1;

        $time = date("Y-m-d", time());
        if (!empty($params['day'])) $time = trim($params['day']);

        $start = $time . " 00:00:00";
        $end = $time . " 23:59:59";
        $start = strtotime($start);
        $end = strtotime($end);
        $where = [$start, $end];

        $scheduleModel = new ScheduleMatchModel();
        $whereIn = "0";

        if (!empty($params['leagueId'])) $whereType['sc.leagueId'] = $params['leagueId'];
        if (!empty($params['leagueType'])) $whereType['sc.leagueType'] = $params['leagueType'];

        try {

            if (!empty($whereType)) {
                if (!empty($params['day'])) {
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->where($whereType)->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                } else {
                    $where = "matchStartTime >= " . time();
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->where($whereType)->where($where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                }

            } else {
                if (!empty($params['day'])) {
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                } else {
                    $res = [];
                    $res = $scheduleModel->alias('sc')->join('team te', 'te.teamId = sc.homeId')->join('team tm', 'tm.teamId = sc.awayId')->join('leagues le', 'le.leagueId = sc.leagueId')->whereBetween('sc.matchStartTime', $where)->whereIn('sc.state', $whereIn)->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs', 'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime', 'sc.leagueChsShort', "sc.technicCount", 'sc.homeScore', 'sc.awayScore', 'sc.isPosition', 'sc.leagueId', 'sc.reserveNum', 'te.logo as homeLogo', 'tm.logo as awayLogo', 'le.leagueLogo', 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow', 'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])->order(['sc.state' => "DESC", 'sc.matchStartTime' => "AEC"])->paginate([
                        'list_rows' => $page_size,
                        'page'      => $page,
                    ]);
                }

            }
            if (!empty($res)) return $res->toArray();

            return $res;
        } catch (DbException $e) {
            return ['code' => 2301, 'msg' => $e->getMessage()];
        }
    }

    public function match($data)
    {
        $whereIn = '0,1,2,3,4,5';
        $whereBtw = $data['whereBtw'];
        $whereInSc = '0,1,2,3,4,5,-1';
        $leagueType['leagueType'] = 1;
        $hierarchy['hierarchy'] = 1; // 赛事级别

        // playing参数为比赛状态(schedule表中的state) 0:未开 1:上半场 2:中场 3:下半场 4:加时 5:点球 -1:完场
        if (!empty($data['playing'])) {
            if ($data['playing'] == '2000') $whereIn = "1,2,3,4,5";
            if ($data['playing'] == '1000') $whereIn = '0';
            if ($data['playing'] == '3000') $whereIn = '0,1,2,3,4,5';
        }

        $scheduleModel = new ScheduleMatchModel();

        $res = $scheduleModel->whereIn('state', $whereInSc)
            ->whereBetween('matchStartTime', $whereBtw)->where($leagueType)
            ->field(['matchId'])->count();

        unset($whereBtw);
        $whereBtw = [$data['whereBtw'][0], $data['whereBtw'][1] + 518400]; // 加6天

        $lists = $scheduleModel->alias('sc')
            ->join('team te', 'te.teamId = sc.homeId')
            ->join('team tm', 'tm.teamId = sc.awayId')
            ->join('leagues le', 'le.leagueId = sc.leagueId')
            ->whereIn('sc.state', $whereIn)->whereIn('le.hierarchy', $hierarchy)->whereBetween('sc.matchStartTime', $whereBtw)
            ->field(['sc.color', 'sc.matchId', 'sc.homeId', 'sc.awayId', 'sc.homeChs',
                'sc.awayChs', 'sc.matchStartTime', 'sc.state', 'sc.matchTime',
                'sc.leagueChsShort', 'sc.technicCount', 'sc.homeScore', 'sc.awayScore',
                'sc.isPosition', 'sc.leagueId', 'te.logo as homeLogo', 'tm.logo as awayLogo',
                'le.leagueLogo', 'le.hierarchy' , 'sc.homeRed', 'sc.awayRed', 'sc.homeYellow', 'sc.awayYellow',
                'sc.homeCorner', 'sc.awayCorner', 'sc.homeHalfScore', 'sc.awayHalfScore'])
            ->order('sc.matchStartTime', 'ASC')->limit(20)->select()->all();

        $result['total'] = 0;
        if (!empty($res)) $result['total'] = $res;

        $result['list'] = null;
        if (!empty($lists)) $result['list'] = $lists;

        return $result;
    }

    public function followLists($match_id)
    {
        $params = request()->post();
        $page_size = $params['pageSize'] ?? 10;
        $page = $params['pageNum'] ?? 1;
        if (!empty($params['match_status']) && $params['match_status'] == '3000') {
            $res = ScheduleMatchModel::whereIn('matchId', $match_id)->field(['sc.color', 'color', 'matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'homeScore', 'awayScore', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeRankCn', 'awayRankCn', 'follow as reserveNum', 'startTime', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeHalfScore', 'awayHalfScore'])->order(['state' => 'DESC', 'matchStartTime' => 'DESC'])->paginate([
                'list_rows' => $page_size,
                'page'      => $page,
            ]);
        } else {
            $res = ScheduleMatchModel::whereIn('matchId', $match_id)->field(['color', 'matchId', 'homeId', 'awayId', 'homeChs', 'awayChs', 'matchStartTime', 'state', 'matchTime', 'leagueChsShort', 'homeScore', 'awayScore', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeRankCn', 'awayRankCn', 'follow as reserveNum', 'startTime', 'homeRed', 'awayRed', 'homeYellow', 'awayYellow', 'homeCorner', 'awayCorner', 'homeHalfScore', 'awayHalfScore'])->order(['state' => 'DESC', 'matchStartTime' => 'AEC'])->paginate([
                'list_rows' => $page_size,
                'page'      => $page,
            ]);
        }

        return $res->toArray();
    }

    public function isH5()
    {
        //全部变成小写字母
        $agent = strtolower($_SERVER['HTTP_USER_AGENT']);
        if (strpos($agent, 'iphone') !== false || strpos($agent, 'ipad') !== false) {
            $device = 'IOS';
        } elseif (strpos($agent, 'android') !== false) {
            $device = 'Android';
        } elseif (strpos($agent, 'windows') !== false) {
            $device = 'PC';
            if (IS_MOBILE) $device = 'H5';
        } else {
            $device = 'PC';
            if (IS_MOBILE) $device = 'H5';
        }
        return $device;
    }

    public function startEndTime($day) {

        if (!empty($day)) {
            $today = trim($day);
            $tomorrow = date("Y-m-d", strtotime("+1 day", strtotime(trim($day))));
        } else {
            $today = date("Y-m-d", time());
            $tomorrow = date("Y-m-d", strtotime("+1 day"));
        }
        $start = strtotime($today . $this->startTime);
        $end = strtotime($tomorrow . $this->endTime);
        $whereBtw = [$start, $end];

        return $whereBtw;
    }

}
```

